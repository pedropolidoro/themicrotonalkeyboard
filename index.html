<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Microtonal MIDI Keyboard 1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Styles for the body and keyboard keys */
        body {
            background-color: #F0F0F0;
            background-image: radial-gradient(#CCCCCC 1px, transparent 1px);
            background-size: 20px 20px;
            color: #000000;
            font-family: 'Roboto Mono', monospace;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        .key {
            display: inline-block;
            width: 60px;
            height: 60px;
            margin: 4px;
            cursor: pointer;
            border-radius: 50%;
            background-color: #555555;
            color: #F0F0F0;
            line-height: 60px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #000000;
            transition: background-color 0.3s ease, transform 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .key.pressed {
            background-color: #FF6F61;
            color: #FFFFFF;
            transform: scale(1.1);
        }

    .key:focus-visible, .drum-pad:focus-visible {
            outline: double #ff6f61 6px;
            outline-offset: -4px;
    }

    .cents-indicator {
	    font-size: 0.46em;
    }

    .active.drum-pad:focus-visible {
        outline-color: black;
        border-color: #FF6F61;
    }

    .pressed.key:focus-visible {
            outline: none;
    }

        /* Styles for control buttons and sliders */
        .controls select {
            scrollbar-width: thin;
        } /* @supports not (scrollbar-width: thin){ .controls select::-webkit-scrollbar { width: 9px; } } */

        .controls button, .controls select {
            margin: 5px;
            padding: 10px;
            border: 2px solid #000000;
            background-color: #4e4e4e;
            color: #F0F0F0;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .controls button:hover, .controls button:focus-visible, .controls select:focus-within, .controls select:hover {
            background-color: #FF6F61;
            color: #FFFFFF;
            border-color: #333333;
        }

        .controls button.active {
            background-color: #FF6F61;
            color: #FFFFFF;
        }

        /* Styles for volume, tempo, and drum volume sliders */

        .value-indicator { justify-self: start; }

        [id="volume-container"] {
            display: grid;
            grid-template-columns: auto auto 7.4ch;
            justify-items: flex-end;
            justify-content: center;
            align-items: center;
            gap: 20px 9px;
            grid-auto-rows: min-content;
            padding-bottom: 20px;
        }

        .slider-container {
            display: contents;
        }


        #volume-slider, #tempo-slider, #drum-volume-slider {
            width: 300px;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: #CCCCCC;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        #volume-slider:hover, #volume-slider:focus-visible,
        #tempo-slider:hover, #tempo-slider:focus-visible,
        #drum-volume-slider:hover, #drum-volume-slider:focus-visible {
            opacity: 1;
        }

        #volume-slider::-webkit-slider-thumb, #tempo-slider::-webkit-slider-thumb, #drum-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #FF6F61;
            cursor: pointer;
            border-radius: 10px;
        }


        #volume-slider::-moz-range-thumb, #tempo-slider::-moz-range-thumb, #drum-volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #FF6F61;
            cursor: pointer;
            border-radius: 15px;
        }

        #volume-slider:focus-visible::-moz-range-thumb, #tempo-slider:focus-visible::-moz-range-thumb, #drum-volume-slider:focus-visible::-moz-range-thumb/*, #tempo-slider::-moz-range-thumb, #drum-volume-slider::-moz-range-thumb*/{
            border: solid 3px black;
        }

        /* Styles for drum pads and progress steps */
        .drum-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .drum-row label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }

        .drum-pad {
            padding: 20px;
            background-color: #555555;
            border: 2px solid #000000;
            border-radius: 10px;
            cursor: pointer;
            margin: 2px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .drum-pad.active {
            background-color: #FF6F61;
            color: #FFFFFF;
            transform: scale(1.1);
        }

        .drum-pad.current {
            background-color: #333333;
            color: #FFFFFF;
        }

        .progress-step {
            width: 30px;
            height: 10px;
            background-color: #CCCCCC;
            margin: 2px;
        }

        .progress-step.current {
            background-color: #FF6F61;
        }

        .key-octave {
            margin-bottom: 20px; /* Add margin between octaves */
        }

        /* Styles for the About popup */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            background-color: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
            z-index: 1000;
        }

        .popup.active {
            display: block;
        }

        .popup h2 {
            margin-top: 0;
        }

        .popup p {
            margin-bottom: 20px;
        }

        .popup .close-btn {
            background-color: #FF6F61;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }

        /* Styles for the About button */
        #about-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #FF6F61;
            color: #FFFFFF;
            border: 2px solid #000000;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #about-btn:hover {
            background-color: #F0F0F0;
            color: #FF6F61;
        }

        #about-btn:focus-visible, .close-btn:focus-visible, .controls select:focus-visible, .controls button:focus-visible {
            outline: double #000 6px;
            outline-offset: -4px;
            border-color: #FF6F61;
    }
    </style>
</head>
<body>
    <h1>The Microtonal MIDI Keyboard 1.0</h1>
    <p>by <a href="https://github.com/zaheralkaei" target="_blank" rel="noreferrer noopener" style="color: #333333;">Zaher Alkaei</a></p>
    <div id="keyboard-container">
        <div id="keyboard">
            <!-- Keys will be generated by JavaScript -->
        </div>
    </div>
    <div class="controls">
        <select id="edo-select">
            <option value="5">5 EDO</option>
            <option value="7">7 EDO</option>
            <option value="9">9 EDO</option>
            <option value="12" selected>12 EDO</option>
            <option value="17">17 EDO</option>
            <option value="19">19 EDO</option>
            <option value="22">22 EDO</option>
            <option value="24">24 EDO</option>
            <option value="31">31 EDO</option>
            <option value="33">33 EDO</option>
            <option value="53">53 EDO</option>
        </select>
        <select id="octave-select">
            <option value="1" selected>1 Octave</option>
            <option value="2">2 Octaves</option>
            <option value="3">3 Octaves</option>
        </select>
        <button id="toggle-reverb">Toggle Reverb</button>
        <button id="toggle-arpeggiator">Toggle Arpeggiator</button>
        <select id="synth-select">
            <option value="sine" selected>Sine Synth</option>
            <option value="square">Square Synth</option>
            <option value="triangle">Triangle Synth</option>
            <option value="sawtooth">Sawtooth Synth</option>
    </select>
    <select id="keyNamingId" aria-labe="key naming">
            <option value="sequence" selected>Sequence</option>
            <option value="simpleSequence">Simple Sequence</option>
            <option value="name12edo">Name 12 EDO</option>
            <option value="name24edo">Name 24 EDO</option>
            <option value="namePythagorean">Name Pythagorean</option>
        <option value="simpleCents">Simple Cents</option>
    </select>

    </div>
    <div id="volume-container">
        <div class="slider-container">
            <label for="volume-slider" class="slider-label">Volume (%)</label>
            <input type="range" id="volume-slider" min="0" max="100" value="50">
            <span class="value-indicator" id="volume-value">50%</span>
        </div>
        <div class="slider-container">
            <label for="tempo-slider" class="slider-label">Tempo (BPM)</label>
            <input type="range" id="tempo-slider" min="30" max="240" value="120">
            <span class="value-indicator" id="tempo-value">120 BPM</span>
        </div>
        <div class="slider-container">
            <label for="drum-volume-slider" class="slider-label">Drum Volume (%)</label>
            <input type="range" id="drum-volume-slider" min="0" max="100" value="50">
            <span class="value-indicator" id="drum-volume-value">50%</span>
        </div>
    </div>
    <div class="controls">
        <button id="play-stop">Play Drum Machine</button>
        <button id="reverb-button" class="effect-button">Reverb</button>
        <button id="distortion-button" class="effect-button">Distortion</button>
    </div>
    <div class="controls">
        <label for="length">Rhythm Length:</label>
        <select id="length">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
        </select>
        <label for="preset">Preset Rhythms:</label>
        <select id="preset">
            <option value="standard">Standard</option>
            <option value="electro">Electro</option>
            <option value="techno">Techno</option>
            <option value="pop">Pop</option>
            <option value="rock">Rock</option>
            <option value="house">House</option>
            <option value="funk">Funk</option>
            <option value="jazz">Jazz</option>
            <option value="progressive">Progressive</option>
            <option value="progressive2">Progressive 2</option>
        </select>
        <label for="drum-sound">Drum Sound:</label>
        <select id="drum-sound">
            <option value="standard">Standard</option>
            <option value="electro">Electro</option>
        </select>
    </div>
    <div id="drum-pads">
        <!-- Drum pads will be generated here by JavaScript -->
    </div>

    <button id="about-btn">About</button>

    <div id="about-popup" class="popup">
        <h2>About The Microtonal MIDI Keyboard 1.0</h2>
        <p>This web application is designed to provide a microtonal keyboard interface with various equal divisions of the octave (EDO) and drum machine functionality. It allows users to experiment with different microtonal scales and create rhythms using synthesized drum sounds.</p>
        <p>The application is built using the Tone.js library for audio synthesis and manipulation.</p>
        <p>At the moment there is no mapping to the computer keyboard. You can control this application by using the mouse cursor or a touchscreen.</p>
        <p>Developed by <a href="https://github.com/zaheralkaei" target="_blank" rel="noreferrer noopener">Zaher Alkaei</a>. You can find the source code on <a href="https://github.com/zaheralkaei/themicrotonalkeyboard" target="_blank" rel="noreferrer noopener">GitHub</a>.</p>
        <button class="close-btn" onclick="toggleAbout()">Close</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
    <script>
        // Constants and configurations
        const baseFrequency = 261.63; // C4 frequency
        const edoConfigs = {
            5: { keys: 5, rows: 1 },
            7: { keys: 7, rows: 1 },
            9: { keys: 9, rows: 1 },
            12: { keys: 12, rows: 1 },
            17: { keys: 17, rows: 2 },
            19: { keys: 19, rows: 2 },
            22: { keys: 22, rows: 2 },
            24: { keys: 24, rows: 2 },
            31: { keys: 31, rows: 2 },
            33: { keys: 33, rows: 2 },
            53: { keys: 53, rows: 2 }
        };

        // Names of keys according to 12 EDO
        const namesKeys12Edo = {
            5: [
                ["C", ""],
                ["D", "+40Â¢"],
                ["F", "-20Â¢"],
                ["G", "+20Â¢"],
                ["Aâ™¯", "-40Â¢"]
            ],

            7: [
                ["C", ""],
                ["D", "-29Â¢"],
                ["Dâ™¯", "+43Â¢"],
                ["F", "+14Â¢"],
                ["G", "-14Â¢"],
                ["A", "-43Â¢"],
                ["Aâ™¯", "+29Â¢"]
            ],

            9: [
                ["C", ""],
                ["Câ™¯", "+33Â¢"],
                ["Dâ™¯", "-33Â¢"],
                ["E", ""],
                ["F", "+33Â¢"],
                ["G", "-33Â¢"],
                ["Gâ™¯", ""],
                ["A", "+33Â¢"],
                ["B", "-33Â¢"]
            ],

            12: [
                ["C", ""],
                ["Câ™¯", ""],
                ["D", ""],
                ["Dâ™¯", ""],
                ["E", ""],
                ["F", ""],
                ["Fâ™¯", ""],
                ["G", ""],
                ["Gâ™¯", ""],
                ["A", ""],
                ["Aâ™¯", ""],
                ["B", ""]
            ],

            17: [
                ["C", ""],
                ["Câ™¯", "-29Â¢"],
                ["Câ™¯", "+41Â¢"],
                ["D", "+12Â¢"],
                ["Dâ™¯", "-18Â¢"],
                ["E", "-47Â¢"],
                ["E", "+24Â¢"],
                ["F", "-6Â¢"],
                ["Fâ™¯", "-35Â¢"],
                ["Fâ™¯", "+35Â¢"],
                ["G", "+6Â¢"],
                ["Gâ™¯", "-24Â¢"],
                ["Gâ™¯", "+47Â¢"],
                ["A", "+18Â¢"],
                ["Aâ™¯", "-12Â¢"],
                ["B", "-41Â¢"],
                ["B", "+29Â¢"]
            ],

            19: [
                ["C", ""],
                ["Câ™¯", "-37Â¢"],
                ["Câ™¯", "+26Â¢"],
                ["D", "-11Â¢"],
                ["Dâ™¯", "-47Â¢"],
                ["Dâ™¯", "+16Â¢"],
                ["E", "-21Â¢"],
                ["E", "+42Â¢"],
                ["F", "+5Â¢"],
                ["Fâ™¯", "-32Â¢"],
                ["Fâ™¯", "+32Â¢"],
                ["G", "-5Â¢"],
                ["Gâ™¯", "-42Â¢"],
                ["Gâ™¯", "+21Â¢"],
                ["A", "-16Â¢"],
                ["A", "+47Â¢"],
                ["Aâ™¯", "+11Â¢"],
                ["B", "-26Â¢"],
                ["B", "+37Â¢"]
            ],

            22: [
                ["C", ""],
                ["Câ™¯", "-45Â¢"],
                ["Câ™¯", "+9Â¢"],
                ["D", "-36Â¢"],
                ["D", "+18Â¢"],
                ["Dâ™¯", "-27Â¢"],
                ["Dâ™¯", "+27Â¢"],
                ["E", "-18Â¢"],
                ["E", "+36Â¢"],
                ["F", "-9Â¢"],
                ["F", "+45Â¢"],
                ["Fâ™¯", ""],
                ["G", "-45Â¢"],
                ["G", "+9Â¢"],
                ["Gâ™¯", "-36Â¢"],
                ["Gâ™¯", "+18Â¢"],
                ["A", "-27Â¢"],
                ["A", "+27Â¢"],
                ["Aâ™¯", "-18Â¢"],
                ["Aâ™¯", "+36Â¢"],
                ["B", "-9Â¢"],
                ["B", "+45Â¢"]
            ],

            24: [
                ["C", ""],
                ["Câ™¯", "-50Â¢"],
                ["Câ™¯", ""],
                ["D", "-50Â¢"],
                ["D", ""],
                ["D", "+50Â¢"],
                ["Dâ™¯", ""],
                ["E", "-50Â¢"],
                ["E", ""],
                ["E", "+50Â¢"],
                ["F", ""],
                ["F", "+50Â¢"],
                ["Fâ™¯", ""],
                ["Fâ™¯", "+50Â¢"],
                ["G", ""],
                ["G", "+50Â¢"],
                ["Gâ™¯", ""],
                ["A", "-50Â¢"],
                ["A", ""],
                ["A", "+50Â¢"],
                ["Aâ™¯", ""],
                ["Aâ™¯", "+50Â¢"],
                ["B", ""],
                ["B", "+50Â¢"]
            ],

            31: [
                ["C", ""],
                ["C", "+39Â¢"],
                ["Câ™¯", "-23Â¢"],
                ["Câ™¯", "+16Â¢"],
                ["D", "-45Â¢"],
                ["D", "-6Â¢"],
                ["D", "+32Â¢"],
                ["Dâ™¯", "-29Â¢"],
                ["Dâ™¯", "+10Â¢"],
                ["Dâ™¯", "+48Â¢"],
                ["E", "-13Â¢"],
                ["E", "+26Â¢"],
                ["F", "-35Â¢"],
                ["F", "+3Â¢"],
                ["F", "+42Â¢"],
                ["Fâ™¯", "-19Â¢"],
                ["Fâ™¯", "+19Â¢"],
                ["G", "-42Â¢"],
                ["G", "-3Â¢"],
                ["G", "+35Â¢"],
                ["Gâ™¯", "-26Â¢"],
                ["Gâ™¯", "+13Â¢"],
                ["A", "-48Â¢"],
                ["A", "-10Â¢"],
                ["A", "+29Â¢"],
                ["Aâ™¯", "-32Â¢"],
                ["Aâ™¯", "+6Â¢"],
                ["Aâ™¯", "+45Â¢"],
                ["B", "-16Â¢"],
                ["B", "+23Â¢"],
                ["C", "-39Â¢"]
            ],

            33: [
                ["C", ""],
                ["C", "+36Â¢"],
                ["Câ™¯", "-27Â¢"],
                ["Câ™¯", "+9Â¢"],
                ["Câ™¯", "+45Â¢"],
                ["D", "-18Â¢"],
                ["D", "+18Â¢"],
                ["Dâ™¯", "-45Â¢"],
                ["Dâ™¯", "-9Â¢"],
                ["Dâ™¯", "+27Â¢"],
                ["E", "-36Â¢"],
                ["E", ""],
                ["E", "+36Â¢"],
                ["F", "-27Â¢"],
                ["F", "+9Â¢"],
                ["F", "+45Â¢"],
                ["Fâ™¯", "-18Â¢"],
                ["Fâ™¯", "+18Â¢"],
                ["G", "-45Â¢"],
                ["G", "-9Â¢"],
                ["G", "+27Â¢"],
                ["Gâ™¯", "-36Â¢"],
                ["Gâ™¯", ""],
                ["Gâ™¯", "+36Â¢"],
                ["A", "-27Â¢"],
                ["A", "+9Â¢"],
                ["A", "+45Â¢"],
                ["Aâ™¯", "-18Â¢"],
                ["Aâ™¯", "+18Â¢"],
                ["B", "-45Â¢"],
                ["B", "-9Â¢"],
                ["B", "+27Â¢"],
                ["C", "-36Â¢"]
            ],

            53: [
                ["C", ""],
                ["C", "+23Â¢"],
                ["C", "+45Â¢"],
                ["Câ™¯", "-32Â¢"],
                ["Câ™¯", "-9Â¢"],
                ["Câ™¯", "+13Â¢"],
                ["Câ™¯", "+36Â¢"],
                ["D", "-42Â¢"],
                ["D", "-19Â¢"],
                ["D", "+4Â¢"],
                ["D", "+26Â¢"],
                ["D", "+49Â¢"],
                ["Dâ™¯", "-28Â¢"],
                ["Dâ™¯", "-6Â¢"],
                ["Dâ™¯", "+17Â¢"],
                ["Dâ™¯", "+40Â¢"],
                ["E", "-38Â¢"],
                ["E", "-15Â¢"],
                ["E", "+8Â¢"],
                ["E", "+30Â¢"],
                ["F", "-47Â¢"],
                ["F", "-25Â¢"],
                ["F", "-2Â¢"],
                ["F", "+21Â¢"],
                ["F", "+43Â¢"],
                ["Fâ™¯", "-34Â¢"],
                ["Fâ™¯", "-11Â¢"],
                ["Fâ™¯", "+11Â¢"],
                ["Fâ™¯", "+34Â¢"],
                ["G", "-43Â¢"],
                ["G", "-21Â¢"],
                ["G", "+2Â¢"],
                ["G", "+25Â¢"],
                ["G", "+47Â¢"],
                ["Gâ™¯", "-30Â¢"],
                ["Gâ™¯", "-8Â¢"],
                ["Gâ™¯", "+15Â¢"],
                ["Gâ™¯", "+38Â¢"],
                ["A", "-40Â¢"],
                ["A", "-17Â¢"],
                ["A", "+6Â¢"],
                ["A", "+28Â¢"],
                ["Aâ™¯", "-49Â¢"],
                ["Aâ™¯", "-26Â¢"],
                ["Aâ™¯", "-4Â¢"],
                ["Aâ™¯", "+19Â¢"],
                ["Aâ™¯", "+42Â¢"],
                ["B", "-36Â¢"],
                ["B", "-13Â¢"],
                ["B", "+9Â¢"],
                ["B", "+32Â¢"],
                ["C", "-45Â¢"],
                ["C", "-23Â¢"]
            ]
        };

        // Names of keys according to 24 EDO
        // https://w3c.github.io/smufl/latest/tables/stein-zimmermann-accidentals-24-edo.html
        const namesKeys24Edo = {
            5: [
                ["C", ""],
                ["DÇ‚", "-10Â¢"],
                ["F", "-20Â¢"],
                ["G", "+20Â¢"],
                ["AÇ‚", "+10Â¢"]
            ],

            7: [
                ["C", ""],
                ["Câ™¯Ç‚", "+21Â¢"],
                ["Dâ™¯Ç‚", "-8Â¢"],
                ["F", "+14Â¢"],
                ["G", "-14Â¢"],
                ["Gâ™¯Ç‚", "-+7Â¢"],
                ["Aâ™¯Ç‚", "-22Â¢"]
            ],

            9: [
                ["C", ""],
                ["Câ™¯Ç‚", "-17Â¢"],
                ["DÇ‚", "+17Â¢"],
                ["E", ""],
                ["FÇ‚", "-17Â¢"],
                ["Fâ™¯Ç‚", "+17Â¢"],
                ["Gâ™¯", ""],
                ["AÇ‚", "-17Â¢"],
                ["Aâ™¯Ç‚", "+17Â¢"]
            ],

            12: [
                ["C", ""],
                ["Câ™¯", ""],
                ["D", ""],
                ["Dâ™¯", ""],
                ["E", ""],
                ["F", ""],
                ["Fâ™¯", ""],
                ["G", ""],
                ["Gâ™¯", ""],
                ["A", ""],
                ["Aâ™¯", ""],
                ["B", ""]
            ],

            17: [
                ["C", ""],
                ["CÇ‚", "+21Â¢"],
                ["Câ™¯Ç‚", "-9Â¢"],
                ["D", "+12Â¢"],
                ["Dâ™¯", "-17Â¢"],
                ["Dâ™¯Ç‚", "+3Â¢"],
                ["E", "+24Â¢"],
                ["F", "-6Â¢"],
                ["FÇ‚", "+15Â¢"],
                ["Fâ™¯Ç‚", "-15Â¢"],
                ["G", "+6Â¢"],
                ["Gâ™¯", "-24Â¢"],
                ["Gâ™¯Ç‚", "-3Â¢"],
                ["A", "+18Â¢"],
                ["Aâ™¯", "-12Â¢"],
                ["Aâ™¯Ç‚", "+9Â¢"],
                ["BÇ‚", "-21Â¢"]
            ],

            19: [
                ["C", ""],
                ["CÇ‚", "+13Â¢"],
                ["Câ™¯Ç‚", "-24Â¢"],
                ["D", "-11Â¢"],
                ["DÇ‚", "+3Â¢"],
                ["Dâ™¯", "+16Â¢"],
                ["E", "-21Â¢"],
                ["EÇ‚", "-8Â¢"],
                ["F", "+5Â¢"],
                ["FÇ‚", "+18Â¢"],
                ["Fâ™¯Ç‚", "-18Â¢"],
                ["G", "-5Â¢"],
                ["GÇ‚", "+8Â¢"],
                ["Gâ™¯", "Â¢21"],
                ["A", "-6Â¢"],
                ["AÇ‚", "-3Â¢"],
                ["Aâ™¯", "+11Â¢"],
                ["Aâ™¯Ç‚", "+24Â¢"],
                ["BÇ‚", "-13Â¢"]
            ],

            22: [
                ["C", ""],
                ["CÇ‚", "+5Â¢"],
                ["Câ™¯", "+9Â¢"],
                ["Câ™¯Ç‚", "+14Â¢"],
                ["D", "+18Â¢"],
                ["DÇ‚", "+23Â¢"],
                ["Dâ™¯Ç‚", "-23Â¢"],
                ["E", "-18Â¢"],
                ["EÇ‚", "-14Â¢"],
                ["F", "-9Â¢"],
                ["FÇ‚", "-5Â¢"],
                ["Fâ™¯", ""],
                ["Fâ™¯Ç‚", "+5Â¢"],
                ["G", "+9Â¢"],
                ["GÇ‚", "+14Â¢"],
                ["Gâ™¯", "+18Â¢"],
                ["Gâ™¯Ç‚", "+23Â¢"],
                ["AÇ‚", "+23Â¢"],
                ["Aâ™¯", "-18Â¢"],
                ["Aâ™¯Ç‚", "-14Â¢"],
                ["B", "-9Â¢"],
                ["BÇ‚", "-5Â¢"]
            ],

            24: [
                ["C", ""],
                ["Cğ„²", ""],
                ["Câ™¯", ""],
                ["Dğ„³", ""],
                ["D", ""],
                ["Dğ„²", ""],
                ["Dâ™¯", ""],
                ["Eğ„³", ""],
                ["E", ""],
                ["Eğ„²", ""],
                ["F", ""],
                ["Fğ„²", ""],
                ["Fâ™¯", ""],
                ["Fğ„³", ""],
                ["G", ""],
                ["Gğ„²", ""],
                ["Gâ™¯", ""],
                ["Ağ„³", ""],
                ["A", ""],
                ["Ağ„²", ""],
                ["Aâ™¯", ""],
                ["Bğ„³", ""],
                ["B", ""],
                ["Bğ„²", ""]
            ],

            31: [
                ["C", ""],
                ["CÇ‚", "-11Â¢"],
                ["Câ™¯", "-23Â¢"],
                ["Câ™¯", "+16Â¢"],
                ["Câ™¯Ç‚", "+5Â¢"],
                ["D", "-6Â¢"],
                ["DÇ‚", "-18Â¢"],
                ["DÇ‚", "+21Â¢"],
                ["Dâ™¯", "+10Â¢"],
                ["Dâ™¯Ç‚", "-2Â¢"],
                ["E", "-13Â¢"],
                ["EÇ‚", "-24Â¢"],
                ["EÇ‚", "+15Â¢"],
                ["F", "+3Â¢"],
                ["FÇ‚", "-8Â¢"],
                ["Fâ™¯", "-19Â¢"],
                ["Fâ™¯", "+19Â¢"],
                ["Fâ™¯Ç‚", "+8Â¢"],
                ["G", "-3Â¢"],
                ["GÇ‚", "-15Â¢"],
                ["GÇ‚", "+24Â¢"],
                ["Gâ™¯", "+13Â¢"],
                ["Gâ™¯Ç‚", "+2Â¢"],
                ["A", "-10Â¢"],
                ["AÇ‚", "-21Â¢"],
                ["AÇ‚", "+18Â¢"],
                ["Aâ™¯", "+6Â¢"],
                ["Aâ™¯Ç‚", "-5Â¢"],
                ["B", "-16Â¢"],
                ["B", "+23Â¢"],
                ["BÇ‚", "+11Â¢"]
            ],

            33: [
                ["C", ""],
                ["CÇ‚", "-14Â¢"],
                ["CÇ‚", "+23Â¢"],
                ["Câ™¯", "+9Â¢"],
                ["Câ™¯Ç‚", "-5Â¢"],
                ["D", "-18Â¢"],
                ["D", "+18Â¢"],
                ["DÇ‚", "+5Â¢"],
                ["Dâ™¯", "-9Â¢"],
                ["Dâ™¯Ç‚", "-23Â¢"],
                ["Dâ™¯Ç‚", "+14Â¢"],
                ["E", ""],
                ["EÇ‚", "-14Â¢"],
                ["EÇ‚", "+23Â¢"],
                ["F", "+9Â¢"],
                ["FÇ‚", "-5Â¢"],
                ["Fâ™¯", "-18Â¢"],
                ["Fâ™¯", "+18Â¢"],
                ["Fâ™¯Ç‚", "+5Â¢"],
                ["G", "-9Â¢"],
                ["GÇ‚", "-23Â¢"],
                ["GÇ‚", "+14Â¢"],
                ["Gâ™¯", ""],
                ["Gâ™¯Ç‚", "-14Â¢"],
                ["Gâ™¯Ç‚", "+23Â¢"],
                ["A", "+9Â¢"],
                ["AÇ‚", "-5Â¢"],
                ["Aâ™¯", "-18Â¢"],
                ["Aâ™¯", "+18Â¢"],
                ["Aâ™¯Ç‚", "+5Â¢"],
                ["B", "-9Â¢"],
                ["BÇ‚", "-23Â¢"],
                ["BÇ‚", "+14Â¢"]
            ],

            53: [
                ["C", ""],
                ["C", "+23Â¢"],
                ["C", "-5Â¢"],
                ["CÇ‚", "+18Â¢"],
                ["CÇ‚", "-9Â¢"],
                ["Câ™¯", "+13Â¢"],
                ["Câ™¯", "-14Â¢"],
                ["Câ™¯Ç‚", "+8Â¢"],
                ["Câ™¯Ç‚", "-19Â¢"],
                ["D", "+4Â¢"],
                ["D", "-24Â¢"],
                ["DÇ‚", "-1Â¢"],
                ["DÇ‚", "+22Â¢"],
                ["DÇ‚", "-6Â¢"],
                ["Dâ™¯", "+17Â¢"],
                ["Dâ™¯", "-10Â¢"],
                ["Dâ™¯Ç‚", "+12Â¢"],
                ["Dâ™¯Ç‚", "-15Â¢"],
                ["E", "+8Â¢"],
                ["E", "-20Â¢"],
                ["EÇ‚", "+3Â¢"],
                ["EÇ‚", "-25Â¢"],
                ["F", "-2Â¢"],
                ["F", "+21Â¢"],
                ["F", "-7Â¢"],
                ["FÇ‚", "+16Â¢"],
                ["FÇ‚", "-11Â¢"],
                ["Fâ™¯", "+11Â¢"],
                ["Fâ™¯", "-16Â¢"],
                ["Fâ™¯Ç‚", "+7Â¢"],
                ["Fâ™¯Ç‚", "-21Â¢"],
                ["G", "+2Â¢"],
                ["G", "+25Â¢"],
                ["G", "-3Â¢"],
                ["GÇ‚", "+20Â¢"],
                ["GÇ‚", "-8Â¢"],
                ["Gâ™¯", "+15Â¢"],
                ["Gâ™¯", "-12Â¢"],
                ["Gâ™¯Ç‚", "+10Â¢"],
                ["Gâ™¯Ç‚", "-17Â¢"],
                ["A", "+6Â¢"],
                ["A", "-22Â¢"],
                ["AÇ‚", "+1Â¢"],
                ["AÇ‚", "+24Â¢"],
                ["AÇ‚", "-4Â¢"],
                ["Aâ™¯", "+19Â¢"],
                ["Aâ™¯", "-8Â¢"],
                ["Aâ™¯Ç‚", "+14Â¢"],
                ["Aâ™¯Ç‚", "-13Â¢"],
                ["B", "+9Â¢"],
                ["B", "-18Â¢"],
                ["BÇ‚", "+5Â¢"],
                ["BÇ‚", "-23Â¢"],
            ]
        }

        // Pythagorean names 
        const namesKeysPythagorean = {
            5:[
                ["C", ""],
                ["Bx", "-9Â¢"],
                ["Gâ™­â™­", "+5Â¢"],
                ["Fx", "-5Â¢"],
                ["Fâ™­â™­â™­", "+9Â¢"]
            ],

            7:[
                ["C", ""],
                ["Eâ™­â™­", "-10Â¢"],
                ["Cxâ™¯", "+3Â¢"],
                ["Eâ™¯", "-6Â¢"],
                ["Aâ™­â™­", "+7Â¢"],
                ["Exx", "-3Â¢"],
                ["Aâ™¯", "+10Â¢"]
            ],
            9:[
                ["C", ""],
                ["Bx", "-3Â¢"],
                ["Fâ™­â™­", "-5Â¢"],
                ["E", "-6Â¢"],
                ["Dxâ™¯", "-10Â¢"],
                ["Dxx", "+10Â¢"],
                ["Aâ™­", "+6Â¢"],
                ["Gx", "+5Â¢"],
                ["Dâ™­â™­â™­", "+3Â¢"]
            ],
            12:[
                ["C", ""],
                ["Dâ™­", "+9Â¢"],
                ["D",  "-4Â¢"],
                ["Eâ™­", "+6Â¢"],
                ["E",  "-8Â¢"],
                ["F",  "+2Â¢"],
                ["Gâ™­", "+12Â¢"],
                ["G",  "-2Â¢"],
                ["Aâ™­", "+8Â¢"],
                ["A",  "-5Â¢"],
                ["Bâ™­", "+4Â¢"],
                ["B",  "-10Â¢"]            
            ],
            17:[
                ["C", ""],
                ["Eâ™­â™­â™­", "+3Â¢"],
                ["Bx", "+5Â¢"],
                ["D", "+8Â¢"],
                ["Fâ™­â™­", "+11Â¢"],
                ["Gâ™­â™­â™­", "-9Â¢"],
                ["Dx", "-7Â¢"],
                ["F", "-4Â¢"],
                ["Aâ™­â™­â™­", "-1Â¢"],
                ["Ex", "+1Â¢"],
                ["G", "+4Â¢"],
                ["Bâ™­â™­â™­", "+7Â¢"],
                ["Fxâ™¯", "+9Â¢"],
                ["Gx", "-11Â¢"],
                ["Bâ™­", "-8Â¢"],
                ["Dâ™­â™­â™­", "-5Â¢"],
                ["Ax", "-3Â¢"],
            ],
            19:[
                ["C", ""],
                ["Eâ™­â™­â™­", "-5Â¢"],
                ["Bx", "-10Â¢"],
                ["Eâ™­â™­", "+8Â¢"],
                ["Bxâ™¯", "+4Â¢"],
                ["Dâ™¯", "-1Â¢"],
                ["Fâ™­", "-6Â¢"],
                ["Aâ™­â™­â™­", "-11Â¢"],
                ["F", "+7Â¢"],
                ["Aâ™­â™­â™­", "+2Â¢"],
                ["Ex", "-2Â¢"],
                ["G", "-7Â¢"],
                ["Exâ™¯", "+11Â¢"],
                ["Gâ™¯", "+6Â¢"],
                ["Bâ™­â™­", "+1Â¢"],
                ["Fxx", "-6Â¢"],
                ["Aâ™¯", "-8Â¢"],
                ["Dâ™­â™­â™­", "+10Â¢"],
                ["Ax", "+5"]
            ],

            22:[
                ["C", ""],
                ["Axâ™¯", "+9Â¢"],
                ["Câ™¯", "-4Â¢"],
                ["Axx ", "+5Â¢"],
                ["Cx", "-8Â¢"],
                ["Fâ™­â™­", "+1Â¢"],
                ["Dâ™¯", "+10Â¢"],
                ["Fâ™­", "-3 Â¢"],
                ["Dx", "+6 Â¢"],
                ["F", "-7 Â¢"],
                ["Dxâ™¯", "+2 Â¢"],
                ["Gâ™­", "+11Â¢"],
                ["Dxx ", "-2 Â¢"],
                ["G", "+7 Â¢"],
                ["Bâ™­â™­â™­", "-6 Â¢"],
                ["Gâ™¯", "+3 Â¢"],
                ["Dâ™­â™­", "-10Â¢"],
                ["Gx", "-1 Â¢"],
                ["Câ™­â™­", "+8Â¢"],
                ["Gxâ™¯", "-5Â¢"],
                ["Câ™­", "+4Â¢"],
                ["Eâ™­â™­â™­", "-9Â¢"]
            ],
            24:[
                ["C", ""],
                ["Axâ™¯", "+5Â¢"], 
                ["Dâ™­", "+9Â¢"], 
                ["Fâ™­â™­â™­", "-8Â¢"], 
                ["D", "-4Â¢"], 
                ["Bxâ™¯", "+1Â¢"], 
                ["Eâ™­", "+6Â¢"], 
                ["Cxâ™¯", "+10Â¢"], 
                ["E", "-8Â¢"], 
                ["Cxx", "-3Â¢"], 
                ["F", "+2Â¢"], 
                ["Dxâ™¯", "+7Â¢"], 
                ["Gâ™­", "+11Â¢"], 
                ["Dxx ", "-7Â¢"], 
                ["G", "-2Â¢"], 
                ["Exâ™¯", "+3Â¢"], 
                ["Aâ™­", "+8Â¢"], 
                ["Câ™­â™­â™­", "-10Â¢"], 
                ["A", "-7Â¢"], 
                ["Fxx", "-1Â¢"], 
                ["Bâ™­", "+4Â¢"], 
                ["Gxâ™¯", "+8Â¢"], 
                ["B", "-9Â¢"], 
                ["Gxx", "-8Â¢"] 
            ],
            31:[
                ["C", ""],
                ["Ax#", "-7Â¢"],
                ["Ebbb", "+9Â¢"],
                ["C#", "+3Â¢"],
                ["Axx", "-4Â¢"],
                ["D", "-10Â¢"],
                ["Cx", "+6Â¢"],
                ["Fbb", "-1Â¢"],
                ["D#", "-7Â¢"],
                ["Cx#", "+9Â¢"],
                ["Fb", "+2Â¢"],
                ["Dx", "-4Â¢"],
                ["Gbb", "-11Â¢"],
                ["F", "+5Â¢"],
                ["Dx#", "-1Â¢"],
                ["Gb", "-8Â¢"],
                ["F#", "+8Â¢"],
                ["Dxx", "+1Â¢"],
                ["G", "-5Â¢"],
                ["Fx", "+11Â¢"],
                ["Bbbb", "+4Â¢"],
                ["G#", "-2Â¢"],
                ["Cbbb", "-9Â¢"],
                ["Bbb", "+7Â¢"],
                ["Gx", "+1Â¢"],
                ["Cbb", "-6Â¢"],
                ["Bb", "+10Â¢"],
                ["Gx#", "+4Â¢"],
                ["Cb", "-3Â¢"],
                ["Ax", "-9Â¢"],
                ["Gxx", "+7Â¢"]
            ],

            33:[
                ["C", ""],
                ["Ax#", "-9Â¢"],
                ["Ebbb", "+5Â¢"],
                ["C#", "-4Â¢"],
                ["B#", "+10Â¢"],
                ["Ebb", "+1Â¢"],
                ["Cx", "-8Â¢"],
                ["Bx#", "+5Â¢"],
                ["Eb", "-3Â¢"],
                ["D#", "+10Â¢"],
                ["Bxx", "+1Â¢"],
                ["E", "-8Â¢"],
                ["Dx", "+6Â¢"],
                ["Gbb", "-3Â¢"],
                ["F", "+11Â¢"],
                ["Dx#", "+2Â¢"],
                ["Gb", "-7Â¢"],
                ["F#", "+7Â¢"],
                ["Dxx", "-2Â¢"],
                ["G", "-11Â¢"],
                ["Fx", "+3Â¢"],
                ["Bbbb", "-6Â¢"],
                ["Ab", "+8Â¢"],
                ["Fx#", "-1Â¢"],
                ["Bbb", "-10Â¢"],
                ["A", "+3Â¢"],
                ["Fxx", "-5Â¢"],
                ["Cbb", "+8Â¢"],
                ["A#", "-1Â¢"],
                ["Dbbb", "-10Â¢"],
                ["Cb", "+4Â¢"],
                ["Ax", "-5Â¢"],
                ["Gxx", "+9Â¢"],
            ],
            
            53:[
                ["C", ""],
                ["Bâ™¯", ""],
                ["Axâ™¯", ""],
                ["Eâ™­â™­â™­", ""],
                ["Dâ™­", ""],
                ["Câ™¯", ""],
                ["Bx", ""],
                ["Axx", ""],
                ["Eâ™­â™­", ""],
                ["D", ""],
                ["Cx", ""],
                ["Bxâ™¯", ""],
                ["Fâ™­â™­", ""],
                ["Eâ™­", ""],
                ["Dâ™¯", ""],
                ["Cxâ™¯", ""],
                ["Bxx", ""],
                ["Fâ™­", ""],
                ["E", ""],
                ["Dx", ""],
                ["Cxx", ""],
                ["Gâ™­â™­", ""],
                ["F", ""],
                ["Eâ™¯", ""],
                ["Dxâ™¯", ""],
                ["Aâ™­â™­â™­", ""],
                ["Gâ™­", ""],
                ["Fâ™¯", ""],
                ["Ex", ""],
                ["Dxx", ""],
                ["Aâ™­â™­", ""],
                ["G", ""],
                ["Fx", ""],
                ["Exâ™¯", ""],
                ["Bâ™­â™­â™­", ""],
                ["Aâ™­", ""],
                ["Gâ™¯", ""],
                ["Fxâ™¯", ""],
                ["Exx", ""],
                ["Bâ™­â™­", ""],
                ["A", ""],
                ["Gx", ""],
                ["Fxx", ""],
                ["Câ™­â™­", ""],
                ["Bâ™­", ""],
                ["Aâ™¯", ""],
                ["Gxâ™¯", ""],
                ["Dâ™­â™­â™­", ""],
                ["Câ™­", ""],
                ["B", ""],
                ["Ax", ""],
                ["Gxx", ""],
                ["Dâ™­â™­", ""]
            ]
        } ;

        // Audio context and nodes
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const keys = {};
        let reverbNode = createReverb();
        let isReverbOn = false;
        let isArpeggiatorOn = false;
        let arpeggiatorInterval = null;
        let arpeggiatorNotes = [];
        let arpeggiatorIndex = 0;
        let masterGainNode = context.createGain();
        masterGainNode.connect(context.destination);
        let tempo = 120;

        // Synth configurations
        const synthConfigs = {
            sine: {
                volume: -8,
                oscillator: { type: "sine" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            square: {
                volume: -8,
                oscillator: { type: "square" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            triangle: {
                volume: -8,
                oscillator: { type: "triangle" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            sawtooth: {
                volume: -8,
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            }
        };

        let currentSynth = new Tone.PolySynth(Tone.Synth, synthConfigs.sine).toDestination();

        // Calculate frequencies for given EDO and base frequency
        function calculateFrequencies(edo, octaves, baseFreq = 261.6255653005986) {
            let frequencies = [];
            for (let o = 0; o < octaves; o++) {
                for (let i = 0; i < edo; i++) {
                    frequencies.push(baseFreq * Math.pow(2, (i + o * edo) / edo));
                }
            }
            return frequencies;
        }

        // Create a key element
        function createKey(label, frequency, centsDeviation="") {
            const key = document.createElement('div');
            key.className = 'key';
            key.dataset.frequency = frequency;
            key.innerText = label;
            key.setAttribute('tabindex', '0');
            key.setAttribute('role', 'button');
            key.addEventListener('keydown', (e) => {if (e.key === ' ' || e.key === 'Enter') { handleKeyToggle(frequency, key); e.preventDefault(); } });
            key.addEventListener('keyup', (e) => {if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleKeyUp(frequency, key); } });
            key.addEventListener('mousedown', () => handleKeyToggle(frequency, key));
            key.addEventListener('mouseup', () => handleKeyUp(frequency, key));
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleKeyToggle(frequency, key);
            });
            key.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleKeyUp(frequency, key);
            });
            const centsIndicator = document.createElement('span');
            centsIndicator.classList.add('cents-indicator');
		centsIndicator.textContent = centsDeviation;
            key.appendChild(centsIndicator);

		
            return key;
        }

        // Generate keyboard keys based on selected EDO and octaves
        function generateKeyboard(edo, octaves, keyNaming='sequence') {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';
            const config = edoConfigs[edo];
            const frequencies = calculateFrequencies(edo, octaves);
            let rows = [];

            for (let o = 0; o < octaves; o++) {
                let octaveContainer = document.createElement('div');
                octaveContainer.className = 'key-octave';

                let row1 = document.createElement('div');
                row1.className = 'key-row';
                let row2 = document.createElement('div');
                row2.className = 'key-row';
                let keyName;
		    let centsDeviationString = "";
                for (let i = 0; i < config.keys; i++) {
                    let key;
                    const freqIndex = i + (o * config.keys);
                    if (keyNaming === 'sequence'){
                        keyName = `${i + 1 + (o * config.keys)}`;
                    }
                    else if (keyNaming === 'simpleSequence'){
                       keyName = `${(i + (o * config.keys)) % edo + 1}`;
                    }
                    else if (keyNaming === 'simpleCents'){
                       keyName = `${(Math.trunc(1200 / (edo) * i) % 1200 )}`;
                    }
                    else if (keyNaming === 'name12edo'){
                        keyName = namesKeys12Edo[edo][i % edo][0];
                        centsDeviationString = namesKeys12Edo[edo][i % edo][1];
                    }
                    else if (keyNaming === 'name24edo'){
                        keyName = namesKeys24Edo[edo][i % edo][0];
                        centsDeviationString = namesKeys24Edo[edo][i % edo][1];
                    }
                    else if (keyNaming === 'namePythagorean'){
                        keyName = namesKeysPythagorean[edo][i % edo][0];
                        centsDeviationString = namesKeysPythagorean[edo][i % edo][1];
                    }
                    key = createKey(keyName, frequencies[freqIndex], centsDeviationString);
                    if (config.rows === 2 && i % 2 === 0) { row2.appendChild(key) ; }
                    else { row1.appendChild(key) ; }
                }
                octaveContainer.appendChild(row1);
                if (config.rows === 2) { octaveContainer.appendChild(row2); }
                rows.push(octaveContainer);
            }

            rows.forEach(row => keyboard.appendChild(row));
        }

        // Handle key toggle (mousedown/touchstart)
        function handleKeyToggle(frequency, key) {
            if (isArpeggiatorOn) {
                if (arpeggiatorNotes.some(n => n.frequency === frequency)) {
                    arpeggiatorNotes = arpeggiatorNotes.filter(n => n.frequency !== frequency);
                    key.classList.remove('pressed');
                } else {
                    arpeggiatorNotes.push({ frequency, key });
                    key.classList.add('pressed');
                }
            } else {
                handleKeyDown(frequency, key);
            }
        }

        // Handle key down (mousedown/touchstart)
        function handleKeyDown(frequency, key) {
            if (!keys[frequency]) {
                currentSynth.triggerAttack(frequency);
                keys[frequency] = true;
                key.classList.add('pressed');
            }
        }

        // Handle key up (mouseup/touchend)
        function handleKeyUp(frequency, key) {
            if (keys[frequency]) {
                currentSynth.triggerRelease(frequency);
                delete keys[frequency];
                key.classList.remove('pressed');
            }
        }

        // Toggle reverb effect
        function toggleReverb() {
            isReverbOn = !isReverbOn;
            if (isReverbOn) {
                currentSynth.connect(reverbNode);
            } else {
                currentSynth.disconnect(reverbNode);
            }
            document.getElementById('toggle-reverb').classList.toggle('active', isReverbOn);
        }

        // Create reverb node
        function createReverb() {
            const convolver = new Tone.Reverb(2).toDestination();
            return convolver;
        }

        // Toggle arpeggiator functionality
        function toggleArpeggiator() {
            isArpeggiatorOn = !isArpeggiatorOn;
            if (isArpeggiatorOn) {
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        currentSynth.triggerAttackRelease(noteInfo.frequency, "8n");
                        updateKeyColor(noteInfo.key);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / tempo); // Adjust the interval for the arpeggiator speed
            } else {
                clearInterval(arpeggiatorInterval);
                arpeggiatorNotes = [];
                arpeggiatorIndex = 0;
                resetKeyColors();
            }
            document.getElementById('toggle-arpeggiator').classList.toggle('active', isArpeggiatorOn);
        }

        // Update key color for arpeggiator
        function updateKeyColor(key) {
            key.classList.add('pressed');
            setTimeout(() => {
                key.classList.remove('pressed');
            }, 500);
        }

        // Reset key colors
        function resetKeyColors() {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('pressed');
            });
        }

        // Handle volume change
        function handleVolumeChange(event) {
            const volume = event.target.value;
            currentSynth.volume.value = volume - 50;
            document.getElementById('volume-value').innerText = `${volume}%`;
        }

        // Handle tempo change
        function handleTempoChange(event) {
            tempo = event.target.value;
            document.getElementById('tempo-value').innerText = `${tempo} BPM`;
            if (isArpeggiatorOn) {
                clearInterval(arpeggiatorInterval);
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        currentSynth.triggerAttackRelease(noteInfo.frequency, "8n");
                        updateKeyColor(noteInfo.key);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / tempo); // Adjust the interval for the arpeggiator speed
            }
            Tone.Transport.bpm.value = tempo;
        }

        // Handle drum volume change
        function handleDrumVolumeChange(event) {
            drumVolume = event.target.value;
            drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);
            document.getElementById('drum-volume-value').innerText = `${drumVolume}%`;
        }

        // Handle synth change
        function handleSynthChange(event) {
            const selectedSynth = event.target.value;
            currentSynth = new Tone.PolySynth(Tone.Synth, synthConfigs[selectedSynth]).toDestination();
            if (isReverbOn) {
                currentSynth.connect(reverbNode);
            }
        }

        // Event listeners for EDO and octave selection
        document.getElementById('edo-select').addEventListener('change', () => {
            const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
            generateKeyboard(edo, octaves, keyNamingId.value);
        });

        document.getElementById('octave-select').addEventListener('change', () => {
            const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
            generateKeyboard(edo, octaves, keyNamingId.value);
        });
    document.getElementById('keyNamingId').addEventListener('change', () =>{
        const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
        const naming = keyNamingId.value;
            generateKeyboard(edo, octaves, keyNamingId.value);
    })

        // Event listeners for reverb, arpeggiator, and synth selection
        document.getElementById('toggle-reverb').addEventListener('click', toggleReverb);
        document.getElementById('toggle-arpeggiator').addEventListener('click', toggleArpeggiator);
        document.getElementById('volume-slider').addEventListener('input', handleVolumeChange);
        document.getElementById('tempo-slider').addEventListener('input', handleTempoChange);
        document.getElementById('drum-volume-slider').addEventListener('input', handleDrumVolumeChange);
        document.getElementById('synth-select').addEventListener('change', handleSynthChange);

        // About button event listener
        document.getElementById('about-btn').addEventListener('click', toggleAbout);

        // Generate default keyboard (12 EDO, 1 octave)
        generateKeyboard(12, 1);

        // Drum machine implementation
        const drumPadsContainer = document.getElementById('drum-pads');
        const drumEffectChain = new Tone.Gain().toDestination();
        const drumReverb = new Tone.Reverb(2).toDestination();
        const drumDistortion = new Tone.Distortion(0.4).toDestination();
        let currentDrumPreset = 'standard';
        let currentSynths = {};
        let rhythmLength = parseInt(document.getElementById('length').value);
        let isPlaying = false;
        let drumVolume = 50;

        const sounds = ['hihat', 'snare', 'kick'];
        const synths = {
            standard: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 4,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.01, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' }
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 400,
                    envelope: { attack: 0.001, decay: 0.1, release: 0.8 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
                }).connect(drumEffectChain)
            },
            electro: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.02,
                    octaves: 6,
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 1.2, attackCurve: 'exponential' }
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 300,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.6 },
                    harmonicity: 6,
                    modulationIndex: 24,
                    resonance: 3000,
                    octaves: 1.2
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
                }).connect(drumEffectChain)
            }
        };

        currentSynths = synths[currentDrumPreset];

        Tone.Transport.bpm.value = tempo;
        drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);

        // Create drum pads
        function createDrumPads() {
            drumPadsContainer.innerHTML = '';
            sounds.forEach(sound => {
                const row = document.createElement('div');
                row.classList.add('drum-row');
                const label = document.createElement('label');
                label.textContent = sound.charAt(0).toUpperCase() + sound.slice(1);
                row.appendChild(label);
                for (let i = 0; i < rhythmLength; i++) {
                    const pad = document.createElement('div');
                    pad.classList.add('drum-pad');
                    pad.dataset.sound = sound;
                    pad.dataset.step = i;
                    pad.setAttribute('role', 'button');
                    pad.setAttribute('tabindex', '0');
                    pad.setAttribute('aria-pressed', 'false');
                    pad.addEventListener('keypress', (e) => {if (e.key === " " || e.key === "Enter") {pad.click(); e.preventDefault()} }) ;
                    pad.addEventListener('click', () => {
                        pad.classList.toggle('active');

                        // togle value true/false of aria-pressed
                        if (pad.getAttribute('aria-pressed') === "false"){ pad.setAttribute('aria-pressed', 'true'); }
                        else if (pad.getAttribute('aria-pressed') === "true"){ pad.setAttribute('aria-pressed', 'false'); }
                    });
                    row.appendChild(pad);
                }
                drumPadsContainer.appendChild(row);
            });
        }

        // Create progress row
        function createProgressRow() {
            const progressRow = document.getElementById('progress-row');
            progressRow.innerHTML = '';
            for (let i = 0; i < rhythmLength; i++) {
                const step = document.createElement('div');
                step.classList.add('progress-step');
                step.dataset.step = i;
                progressRow.appendChild(step);
            }
        }

        // Play drum rhythm
        function playRhythm() {
            let step = 0;
            Tone.Transport.scheduleRepeat(time => {
                const currentPads = document.querySelectorAll(`.drum-pad[data-step="${step}"]`);
                const currentSteps = document.querySelectorAll(`.progress-step[data-step="${step}"]`);
                document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
                document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
                currentPads.forEach(pad => {
                    pad.classList.add('current');
                    if (pad.classList.contains('active')) {
                        if (pad.dataset.sound === 'snare') {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("8n", time);
                        } else {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("C3", "8n", time);
                        }
                    }
                });
                currentSteps.forEach(step => {
                    step.classList.add('current');
                });
                step = (step + 1) % rhythmLength;
            }, "8n");
            Tone.Transport.start();
        }

        // Stop drum rhythm
        function stopRhythm() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
            document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
        }

        // Toggle play/stop for drum machine
        function togglePlayStop() {
            if (isPlaying) {
                stopRhythm();
                document.getElementById('play-stop').textContent = 'Play Drum Machine';
            } else {
                playRhythm();
                document.getElementById('play-stop').textContent = 'Stop Drum Machine';
            }
            isPlaying = !isPlaying;
        }

        // Load preset rhythms
        function loadPreset(preset) {
            const presets = {
                standard: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                electro: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 6]],
                        ['snare', [4]]
                    ]
                },
                techno: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [4]]
                    ]
                },
                pop: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                rock: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                house: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                funk: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                },
                jazz: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 5]],
                        ['hihat', [1, 2, 3, 4, 6, 7]],
                        ['snare', [4]]
                    ]
                },
                progressive: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 4, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                progressive2: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 3, 5, 7]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                }
            };

            const selectedPreset = presets[preset];
            if (selectedPreset) {
                rhythmLength = selectedPreset.length;
                document.getElementById('length').value = rhythmLength;
                createDrumPads();
                selectedPreset.patterns.forEach(([sound, steps]) => {
                    steps.forEach(step => {
                        const pad = document.querySelector(`.drum-pad[data-sound="${sound}"][data-step="${step}"]`);
                        if (pad) {
                            pad.classList.add('active');
                            pad.setAttribute('aria-pressed', 'true');
                        }
                    });
                });
            }
        }

        // Handle drum sound change
        function handleDrumSoundChange(event) {
            const selectedSound = event.target.value;
            currentDrumPreset = selectedSound;
            currentSynths = synths[currentDrumPreset];
        }

        // Toggle effect (reverb or distortion)
        function toggleEffect(button, effect, isActive) {
            if (isActive) {
                drumEffectChain.disconnect(effect);
                button.classList.remove('active');
            } else {
                drumEffectChain.connect(effect);
                button.classList.add('active');
            }
            return !isActive;
        }

        let isReverbActive = false;
        let isDistortionActive = false;

        document.getElementById('reverb-button').addEventListener('click', () => {
            isReverbActive = toggleEffect(document.getElementById('reverb-button'), drumReverb, isReverbActive);
        });

        document.getElementById('distortion-button').addEventListener('click', () => {
            isDistortionActive = toggleEffect(document.getElementById('distortion-button'), drumDistortion, isDistortionActive);
        });

        document.getElementById('length').addEventListener('change', (e) => {
            rhythmLength = parseInt(e.target.value);
            createDrumPads();
            if (isPlaying) {
                stopRhythm();
                playRhythm();
            }
        });

        document.getElementById('play-stop').addEventListener('click', togglePlayStop);
        document.getElementById('preset').addEventListener('change', (e) => {
            loadPreset(e.target.value);
        });
        document.getElementById('drum-sound').addEventListener('change', handleDrumSoundChange);

        createDrumPads();
        loadPreset('standard');

        // Toggle About popup
        function toggleAbout() {
            const aboutPopup = document.getElementById('about-popup');
            aboutPopup.classList.toggle('active');
        }
    </script>
</body>
</html>
