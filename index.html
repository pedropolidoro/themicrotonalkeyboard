<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Microtonal MIDI Keyboard 1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Styles for the body and keyboard keys */
        body {
            background-color: #F0F0F0;
            background-image: radial-gradient(#CCCCCC 1px, transparent 1px);
            background-size: 20px 20px;
            color: #000000;
            font-family: 'Roboto Mono', monospace;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        .key {
            display: inline-block;
            width: 60px;
            height: 60px;
            margin: 4px;
            cursor: pointer;
            border-radius: 50%;
            background-color: #555555;
            color: #F0F0F0;
            line-height: 60px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #000000;
            transition: background-color 0.3s ease, transform 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .key.pressed {
            background-color: #FF6F61;
            color: #FFFFFF;
            transform: scale(1.1);
        }

    .key:focus-visible, .drum-pad:focus-visible {
            outline: double #ff6f61 6px;
            outline-offset: -4px;
    }

    .cents-indicator {
	    font-size: 0.46em;
    }

    .active.drum-pad:focus-visible {
        outline-color: black;
        border-color: #FF6F61;
    }

    .pressed.key:focus-visible {
            outline: none;
    }

        /* Styles for control buttons and sliders */
        .controls select {
            scrollbar-width: thin;
        } /* @supports not (scrollbar-width: thin){ .controls select::-webkit-scrollbar { width: 9px; } } */

        .controls button, .controls select {
            margin: 5px;
            padding: 10px;
            border: 2px solid #000000;
            background-color: #4e4e4e;
            color: #F0F0F0;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .controls button:hover, .controls button:focus-visible, .controls select:focus-within, .controls select:hover {
            background-color: #FF6F61;
            color: #FFFFFF;
            border-color: #333333;
        }

        .controls button.active {
            background-color: #FF6F61;
            color: #FFFFFF;
        }

        /* Styles for volume, tempo, and drum volume sliders */

        .value-indicator { justify-self: start; }

        [id="volume-container"] {
            display: grid;
            grid-template-columns: auto auto 7.4ch;
            justify-items: flex-end;
            justify-content: center;
            align-items: center;
            gap: 20px 9px;
            grid-auto-rows: min-content;
            padding-bottom: 20px;
        }

        .slider-container {
            display: contents;
        }


        #volume-slider, #tempo-slider, #drum-volume-slider {
            width: 300px;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: #CCCCCC;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        #volume-slider:hover, #volume-slider:focus-visible,
        #tempo-slider:hover, #tempo-slider:focus-visible,
        #drum-volume-slider:hover, #drum-volume-slider:focus-visible {
            opacity: 1;
        }

        #volume-slider::-webkit-slider-thumb, #tempo-slider::-webkit-slider-thumb, #drum-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #FF6F61;
            cursor: pointer;
            border-radius: 10px;
        }


        #volume-slider::-moz-range-thumb, #tempo-slider::-moz-range-thumb, #drum-volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #FF6F61;
            cursor: pointer;
            border-radius: 15px;
        }

        #volume-slider:focus-visible::-moz-range-thumb, #tempo-slider:focus-visible::-moz-range-thumb, #drum-volume-slider:focus-visible::-moz-range-thumb/*, #tempo-slider::-moz-range-thumb, #drum-volume-slider::-moz-range-thumb*/{
            border: solid 3px black;
        }

        /* Styles for drum pads and progress steps */
        .drum-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .drum-row label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }

        .drum-pad {
            padding: 20px;
            background-color: #555555;
            border: 2px solid #000000;
            border-radius: 10px;
            cursor: pointer;
            margin: 2px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .drum-pad.active {
            background-color: #FF6F61;
            color: #FFFFFF;
            transform: scale(1.1);
        }

        .drum-pad.current {
            background-color: #333333;
            color: #FFFFFF;
        }

        .progress-step {
            width: 30px;
            height: 10px;
            background-color: #CCCCCC;
            margin: 2px;
        }

        .progress-step.current {
            background-color: #FF6F61;
        }

        .key-octave {
            margin-bottom: 20px; /* Add margin between octaves */
        }

        /* Styles for the About popup */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            background-color: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
            z-index: 1000;
        }

        .popup.active {
            display: block;
        }

        .popup h2 {
            margin-top: 0;
        }

        .popup p {
            margin-bottom: 20px;
        }

        .popup .close-btn {
            background-color: #FF6F61;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }

        /* Styles for the About button */
        #about-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #FF6F61;
            color: #FFFFFF;
            border: 2px solid #000000;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #about-btn:hover {
            background-color: #F0F0F0;
            color: #FF6F61;
        }

        #about-btn:focus-visible, .close-btn:focus-visible, .controls select:focus-visible, .controls button:focus-visible {
            outline: double #000 6px;
            outline-offset: -4px;
            border-color: #FF6F61;
    }
    </style>
</head>
<body>
    <h1>The Microtonal MIDI Keyboard 1.0</h1>
    <p>by <a href="https://github.com/zaheralkaei" target="_blank" rel="noreferrer noopener" style="color: #333333;">Zaher Alkaei</a></p>
    <div id="keyboard-container">
        <div id="keyboard">
            <!-- Keys will be generated by JavaScript -->
        </div>
    </div>
    <div class="controls">
        <select id="edo-select">
            <option value="5">5 EDO</option>
            <option value="7">7 EDO</option>
            <option value="9">9 EDO</option>
            <option value="12" selected>12 EDO</option>
            <option value="17">17 EDO</option>
            <option value="19">19 EDO</option>
            <option value="22">22 EDO</option>
            <option value="24">24 EDO</option>
            <option value="31">31 EDO</option>
            <option value="33">33 EDO</option>
            <option value="53">53 EDO</option>
        </select>
        <select id="octave-select">
            <option value="1" selected>1 Octave</option>
            <option value="2">2 Octaves</option>
            <option value="3">3 Octaves</option>
        </select>
        <button id="toggle-reverb">Toggle Reverb</button>
        <button id="toggle-arpeggiator">Toggle Arpeggiator</button>
        <select id="synth-select">
            <option value="sine" selected>Sine Synth</option>
            <option value="square">Square Synth</option>
            <option value="triangle">Triangle Synth</option>
            <option value="sawtooth">Sawtooth Synth</option>
    </select>
    <select id="keyNamingId" aria-labe="key naming">
            <option value="sequence" selected>Sequence</option>
            <option value="simpleSequence">Simple Sequence</option>
            <option value="name12edo">Name 12 EDO</option>
            <option value="name24edo">Name 24 EDO</option>
            <option value="namePythagorean">Name Pythagorean</option>
        <option value="simpleCents">Simple Cents</option>
    </select>

    </div>
    <div id="volume-container">
        <div class="slider-container">
            <label for="volume-slider" class="slider-label">Volume (%)</label>
            <input type="range" id="volume-slider" min="0" max="100" value="50">
            <span class="value-indicator" id="volume-value">50%</span>
        </div>
        <div class="slider-container">
            <label for="tempo-slider" class="slider-label">Tempo (BPM)</label>
            <input type="range" id="tempo-slider" min="30" max="240" value="120">
            <span class="value-indicator" id="tempo-value">120 BPM</span>
        </div>
        <div class="slider-container">
            <label for="drum-volume-slider" class="slider-label">Drum Volume (%)</label>
            <input type="range" id="drum-volume-slider" min="0" max="100" value="50">
            <span class="value-indicator" id="drum-volume-value">50%</span>
        </div>
    </div>
    <div class="controls">
        <button id="play-stop">Play Drum Machine</button>
        <button id="reverb-button" class="effect-button">Reverb</button>
        <button id="distortion-button" class="effect-button">Distortion</button>
    </div>
    <div class="controls">
        <label for="length">Rhythm Length:</label>
        <select id="length">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
        </select>
        <label for="preset">Preset Rhythms:</label>
        <select id="preset">
            <option value="standard">Standard</option>
            <option value="electro">Electro</option>
            <option value="techno">Techno</option>
            <option value="pop">Pop</option>
            <option value="rock">Rock</option>
            <option value="house">House</option>
            <option value="funk">Funk</option>
            <option value="jazz">Jazz</option>
            <option value="progressive">Progressive</option>
            <option value="progressive2">Progressive 2</option>
        </select>
        <label for="drum-sound">Drum Sound:</label>
        <select id="drum-sound">
            <option value="standard">Standard</option>
            <option value="electro">Electro</option>
        </select>
    </div>
    <div id="drum-pads">
        <!-- Drum pads will be generated here by JavaScript -->
    </div>

    <button id="about-btn">About</button>

    <div id="about-popup" class="popup">
        <h2>About The Microtonal MIDI Keyboard 1.0</h2>
        <p>This web application is designed to provide a microtonal keyboard interface with various equal divisions of the octave (EDO) and drum machine functionality. It allows users to experiment with different microtonal scales and create rhythms using synthesized drum sounds.</p>
        <p>The application is built using the Tone.js library for audio synthesis and manipulation.</p>
        <p>At the moment there is no mapping to the computer keyboard. You can control this application by using the mouse cursor or a touchscreen.</p>
        <p>Developed by <a href="https://github.com/zaheralkaei" target="_blank" rel="noreferrer noopener">Zaher Alkaei</a>. You can find the source code on <a href="https://github.com/zaheralkaei/themicrotonalkeyboard" target="_blank" rel="noreferrer noopener">GitHub</a>.</p>
        <button class="close-btn" onclick="toggleAbout()">Close</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
    <script>
        // Constants and configurations
        const baseFrequency = 261.63; // C4 frequency
        const edoConfigs = {
            5: { keys: 5, rows: 1 },
            7: { keys: 7, rows: 1 },
            9: { keys: 9, rows: 1 },
            12: { keys: 12, rows: 1 },
            17: { keys: 17, rows: 2 },
            19: { keys: 19, rows: 2 },
            22: { keys: 22, rows: 2 },
            24: { keys: 24, rows: 2 },
            31: { keys: 31, rows: 2 },
            33: { keys: 33, rows: 2 },
            53: { keys: 53, rows: 2 }
        };

        // Names of keys according to 12 EDO
        const namesKeys12Edo = {
            5: [
                ["C", ""],
                ["D", "+40¢"],
                ["F", "-20¢"],
                ["G", "+20¢"],
                ["A♯", "-40¢"]
            ],

            7: [
                ["C", ""],
                ["D", "-29¢"],
                ["D♯", "+43¢"],
                ["F", "+14¢"],
                ["G", "-14¢"],
                ["A", "-43¢"],
                ["A♯", "+29¢"]
            ],

            9: [
                ["C", ""],
                ["C♯", "+33¢"],
                ["D♯", "-33¢"],
                ["E", ""],
                ["F", "+33¢"],
                ["G", "-33¢"],
                ["G♯", ""],
                ["A", "+33¢"],
                ["B", "-33¢"]
            ],

            12: [
                ["C", ""],
                ["C♯", ""],
                ["D", ""],
                ["D♯", ""],
                ["E", ""],
                ["F", ""],
                ["F♯", ""],
                ["G", ""],
                ["G♯", ""],
                ["A", ""],
                ["A♯", ""],
                ["B", ""]
            ],

            17: [
                ["C", ""],
                ["C♯", "-29¢"],
                ["C♯", "+41¢"],
                ["D", "+12¢"],
                ["D♯", "-18¢"],
                ["E", "-47¢"],
                ["E", "+24¢"],
                ["F", "-6¢"],
                ["F♯", "-35¢"],
                ["F♯", "+35¢"],
                ["G", "+6¢"],
                ["G♯", "-24¢"],
                ["G♯", "+47¢"],
                ["A", "+18¢"],
                ["A♯", "-12¢"],
                ["B", "-41¢"],
                ["B", "+29¢"]
            ],

            19: [
                ["C", ""],
                ["C♯", "-37¢"],
                ["C♯", "+26¢"],
                ["D", "-11¢"],
                ["D♯", "-47¢"],
                ["D♯", "+16¢"],
                ["E", "-21¢"],
                ["E", "+42¢"],
                ["F", "+5¢"],
                ["F♯", "-32¢"],
                ["F♯", "+32¢"],
                ["G", "-5¢"],
                ["G♯", "-42¢"],
                ["G♯", "+21¢"],
                ["A", "-16¢"],
                ["A", "+47¢"],
                ["A♯", "+11¢"],
                ["B", "-26¢"],
                ["B", "+37¢"]
            ],

            22: [
                ["C", ""],
                ["C♯", "-45¢"],
                ["C♯", "+9¢"],
                ["D", "-36¢"],
                ["D", "+18¢"],
                ["D♯", "-27¢"],
                ["D♯", "+27¢"],
                ["E", "-18¢"],
                ["E", "+36¢"],
                ["F", "-9¢"],
                ["F", "+45¢"],
                ["F♯", ""],
                ["G", "-45¢"],
                ["G", "+9¢"],
                ["G♯", "-36¢"],
                ["G♯", "+18¢"],
                ["A", "-27¢"],
                ["A", "+27¢"],
                ["A♯", "-18¢"],
                ["A♯", "+36¢"],
                ["B", "-9¢"],
                ["B", "+45¢"]
            ],

            24: [
                ["C", ""],
                ["C♯", "-50¢"],
                ["C♯", ""],
                ["D", "-50¢"],
                ["D", ""],
                ["D", "+50¢"],
                ["D♯", ""],
                ["E", "-50¢"],
                ["E", ""],
                ["E", "+50¢"],
                ["F", ""],
                ["F", "+50¢"],
                ["F♯", ""],
                ["F♯", "+50¢"],
                ["G", ""],
                ["G", "+50¢"],
                ["G♯", ""],
                ["A", "-50¢"],
                ["A", ""],
                ["A", "+50¢"],
                ["A♯", ""],
                ["A♯", "+50¢"],
                ["B", ""],
                ["B", "+50¢"]
            ],

            31: [
                ["C", ""],
                ["C", "+39¢"],
                ["C♯", "-23¢"],
                ["C♯", "+16¢"],
                ["D", "-45¢"],
                ["D", "-6¢"],
                ["D", "+32¢"],
                ["D♯", "-29¢"],
                ["D♯", "+10¢"],
                ["D♯", "+48¢"],
                ["E", "-13¢"],
                ["E", "+26¢"],
                ["F", "-35¢"],
                ["F", "+3¢"],
                ["F", "+42¢"],
                ["F♯", "-19¢"],
                ["F♯", "+19¢"],
                ["G", "-42¢"],
                ["G", "-3¢"],
                ["G", "+35¢"],
                ["G♯", "-26¢"],
                ["G♯", "+13¢"],
                ["A", "-48¢"],
                ["A", "-10¢"],
                ["A", "+29¢"],
                ["A♯", "-32¢"],
                ["A♯", "+6¢"],
                ["A♯", "+45¢"],
                ["B", "-16¢"],
                ["B", "+23¢"],
                ["C", "-39¢"]
            ],

            33: [
                ["C", ""],
                ["C", "+36¢"],
                ["C♯", "-27¢"],
                ["C♯", "+9¢"],
                ["C♯", "+45¢"],
                ["D", "-18¢"],
                ["D", "+18¢"],
                ["D♯", "-45¢"],
                ["D♯", "-9¢"],
                ["D♯", "+27¢"],
                ["E", "-36¢"],
                ["E", ""],
                ["E", "+36¢"],
                ["F", "-27¢"],
                ["F", "+9¢"],
                ["F", "+45¢"],
                ["F♯", "-18¢"],
                ["F♯", "+18¢"],
                ["G", "-45¢"],
                ["G", "-9¢"],
                ["G", "+27¢"],
                ["G♯", "-36¢"],
                ["G♯", ""],
                ["G♯", "+36¢"],
                ["A", "-27¢"],
                ["A", "+9¢"],
                ["A", "+45¢"],
                ["A♯", "-18¢"],
                ["A♯", "+18¢"],
                ["B", "-45¢"],
                ["B", "-9¢"],
                ["B", "+27¢"],
                ["C", "-36¢"]
            ],

            53: [
                ["C", ""],
                ["C", "+23¢"],
                ["C", "+45¢"],
                ["C♯", "-32¢"],
                ["C♯", "-9¢"],
                ["C♯", "+13¢"],
                ["C♯", "+36¢"],
                ["D", "-42¢"],
                ["D", "-19¢"],
                ["D", "+4¢"],
                ["D", "+26¢"],
                ["D", "+49¢"],
                ["D♯", "-28¢"],
                ["D♯", "-6¢"],
                ["D♯", "+17¢"],
                ["D♯", "+40¢"],
                ["E", "-38¢"],
                ["E", "-15¢"],
                ["E", "+8¢"],
                ["E", "+30¢"],
                ["F", "-47¢"],
                ["F", "-25¢"],
                ["F", "-2¢"],
                ["F", "+21¢"],
                ["F", "+43¢"],
                ["F♯", "-34¢"],
                ["F♯", "-11¢"],
                ["F♯", "+11¢"],
                ["F♯", "+34¢"],
                ["G", "-43¢"],
                ["G", "-21¢"],
                ["G", "+2¢"],
                ["G", "+25¢"],
                ["G", "+47¢"],
                ["G♯", "-30¢"],
                ["G♯", "-8¢"],
                ["G♯", "+15¢"],
                ["G♯", "+38¢"],
                ["A", "-40¢"],
                ["A", "-17¢"],
                ["A", "+6¢"],
                ["A", "+28¢"],
                ["A♯", "-49¢"],
                ["A♯", "-26¢"],
                ["A♯", "-4¢"],
                ["A♯", "+19¢"],
                ["A♯", "+42¢"],
                ["B", "-36¢"],
                ["B", "-13¢"],
                ["B", "+9¢"],
                ["B", "+32¢"],
                ["C", "-45¢"],
                ["C", "-23¢"]
            ]
        };

        // Names of keys according to 24 EDO
        // https://w3c.github.io/smufl/latest/tables/stein-zimmermann-accidentals-24-edo.html
        const namesKeys24Edo = {
            5: [
                ["C", ""],
                ["Dǂ", "-10¢"],
                ["F", "-20¢"],
                ["G", "+20¢"],
                ["Aǂ", "+10¢"]
            ],

            7: [
                ["C", ""],
                ["C♯ǂ", "+21¢"],
                ["D♯ǂ", "-8¢"],
                ["F", "+14¢"],
                ["G", "-14¢"],
                ["G♯ǂ", "-+7¢"],
                ["A♯ǂ", "-22¢"]
            ],

            9: [
                ["C", ""],
                ["C♯ǂ", "-17¢"],
                ["Dǂ", "+17¢"],
                ["E", ""],
                ["Fǂ", "-17¢"],
                ["F♯ǂ", "+17¢"],
                ["G♯", ""],
                ["Aǂ", "-17¢"],
                ["A♯ǂ", "+17¢"]
            ],

            12: [
                ["C", ""],
                ["C♯", ""],
                ["D", ""],
                ["D♯", ""],
                ["E", ""],
                ["F", ""],
                ["F♯", ""],
                ["G", ""],
                ["G♯", ""],
                ["A", ""],
                ["A♯", ""],
                ["B", ""]
            ],

            17: [
                ["C", ""],
                ["Cǂ", "+21¢"],
                ["C♯ǂ", "-9¢"],
                ["D", "+12¢"],
                ["D♯", "-17¢"],
                ["D♯ǂ", "+3¢"],
                ["E", "+24¢"],
                ["F", "-6¢"],
                ["Fǂ", "+15¢"],
                ["F♯ǂ", "-15¢"],
                ["G", "+6¢"],
                ["G♯", "-24¢"],
                ["G♯ǂ", "-3¢"],
                ["A", "+18¢"],
                ["A♯", "-12¢"],
                ["A♯ǂ", "+9¢"],
                ["Bǂ", "-21¢"]
            ],

            19: [
                ["C", ""],
                ["Cǂ", "+13¢"],
                ["C♯ǂ", "-24¢"],
                ["D", "-11¢"],
                ["Dǂ", "+3¢"],
                ["D♯", "+16¢"],
                ["E", "-21¢"],
                ["Eǂ", "-8¢"],
                ["F", "+5¢"],
                ["Fǂ", "+18¢"],
                ["F♯ǂ", "-18¢"],
                ["G", "-5¢"],
                ["Gǂ", "+8¢"],
                ["G♯", "¢21"],
                ["A", "-6¢"],
                ["Aǂ", "-3¢"],
                ["A♯", "+11¢"],
                ["A♯ǂ", "+24¢"],
                ["Bǂ", "-13¢"]
            ],

            22: [
                ["C", ""],
                ["Cǂ", "+5¢"],
                ["C♯", "+9¢"],
                ["C♯ǂ", "+14¢"],
                ["D", "+18¢"],
                ["Dǂ", "+23¢"],
                ["D♯ǂ", "-23¢"],
                ["E", "-18¢"],
                ["Eǂ", "-14¢"],
                ["F", "-9¢"],
                ["Fǂ", "-5¢"],
                ["F♯", ""],
                ["F♯ǂ", "+5¢"],
                ["G", "+9¢"],
                ["Gǂ", "+14¢"],
                ["G♯", "+18¢"],
                ["G♯ǂ", "+23¢"],
                ["Aǂ", "+23¢"],
                ["A♯", "-18¢"],
                ["A♯ǂ", "-14¢"],
                ["B", "-9¢"],
                ["Bǂ", "-5¢"]
            ],

            24: [
                ["C", ""],
                ["C𝄲", ""],
                ["C♯", ""],
                ["D𝄳", ""],
                ["D", ""],
                ["D𝄲", ""],
                ["D♯", ""],
                ["E𝄳", ""],
                ["E", ""],
                ["E𝄲", ""],
                ["F", ""],
                ["F𝄲", ""],
                ["F♯", ""],
                ["F𝄳", ""],
                ["G", ""],
                ["G𝄲", ""],
                ["G♯", ""],
                ["A𝄳", ""],
                ["A", ""],
                ["A𝄲", ""],
                ["A♯", ""],
                ["B𝄳", ""],
                ["B", ""],
                ["B𝄲", ""]
            ],

            31: [
                ["C", ""],
                ["Cǂ", "-11¢"],
                ["C♯", "-23¢"],
                ["C♯", "+16¢"],
                ["C♯ǂ", "+5¢"],
                ["D", "-6¢"],
                ["Dǂ", "-18¢"],
                ["Dǂ", "+21¢"],
                ["D♯", "+10¢"],
                ["D♯ǂ", "-2¢"],
                ["E", "-13¢"],
                ["Eǂ", "-24¢"],
                ["Eǂ", "+15¢"],
                ["F", "+3¢"],
                ["Fǂ", "-8¢"],
                ["F♯", "-19¢"],
                ["F♯", "+19¢"],
                ["F♯ǂ", "+8¢"],
                ["G", "-3¢"],
                ["Gǂ", "-15¢"],
                ["Gǂ", "+24¢"],
                ["G♯", "+13¢"],
                ["G♯ǂ", "+2¢"],
                ["A", "-10¢"],
                ["Aǂ", "-21¢"],
                ["Aǂ", "+18¢"],
                ["A♯", "+6¢"],
                ["A♯ǂ", "-5¢"],
                ["B", "-16¢"],
                ["B", "+23¢"],
                ["Bǂ", "+11¢"]
            ],

            33: [
                ["C", ""],
                ["Cǂ", "-14¢"],
                ["Cǂ", "+23¢"],
                ["C♯", "+9¢"],
                ["C♯ǂ", "-5¢"],
                ["D", "-18¢"],
                ["D", "+18¢"],
                ["Dǂ", "+5¢"],
                ["D♯", "-9¢"],
                ["D♯ǂ", "-23¢"],
                ["D♯ǂ", "+14¢"],
                ["E", ""],
                ["Eǂ", "-14¢"],
                ["Eǂ", "+23¢"],
                ["F", "+9¢"],
                ["Fǂ", "-5¢"],
                ["F♯", "-18¢"],
                ["F♯", "+18¢"],
                ["F♯ǂ", "+5¢"],
                ["G", "-9¢"],
                ["Gǂ", "-23¢"],
                ["Gǂ", "+14¢"],
                ["G♯", ""],
                ["G♯ǂ", "-14¢"],
                ["G♯ǂ", "+23¢"],
                ["A", "+9¢"],
                ["Aǂ", "-5¢"],
                ["A♯", "-18¢"],
                ["A♯", "+18¢"],
                ["A♯ǂ", "+5¢"],
                ["B", "-9¢"],
                ["Bǂ", "-23¢"],
                ["Bǂ", "+14¢"]
            ],

            53: [
                ["C", ""],
                ["C", "+23¢"],
                ["C", "-5¢"],
                ["Cǂ", "+18¢"],
                ["Cǂ", "-9¢"],
                ["C♯", "+13¢"],
                ["C♯", "-14¢"],
                ["C♯ǂ", "+8¢"],
                ["C♯ǂ", "-19¢"],
                ["D", "+4¢"],
                ["D", "-24¢"],
                ["Dǂ", "-1¢"],
                ["Dǂ", "+22¢"],
                ["Dǂ", "-6¢"],
                ["D♯", "+17¢"],
                ["D♯", "-10¢"],
                ["D♯ǂ", "+12¢"],
                ["D♯ǂ", "-15¢"],
                ["E", "+8¢"],
                ["E", "-20¢"],
                ["Eǂ", "+3¢"],
                ["Eǂ", "-25¢"],
                ["F", "-2¢"],
                ["F", "+21¢"],
                ["F", "-7¢"],
                ["Fǂ", "+16¢"],
                ["Fǂ", "-11¢"],
                ["F♯", "+11¢"],
                ["F♯", "-16¢"],
                ["F♯ǂ", "+7¢"],
                ["F♯ǂ", "-21¢"],
                ["G", "+2¢"],
                ["G", "+25¢"],
                ["G", "-3¢"],
                ["Gǂ", "+20¢"],
                ["Gǂ", "-8¢"],
                ["G♯", "+15¢"],
                ["G♯", "-12¢"],
                ["G♯ǂ", "+10¢"],
                ["G♯ǂ", "-17¢"],
                ["A", "+6¢"],
                ["A", "-22¢"],
                ["Aǂ", "+1¢"],
                ["Aǂ", "+24¢"],
                ["Aǂ", "-4¢"],
                ["A♯", "+19¢"],
                ["A♯", "-8¢"],
                ["A♯ǂ", "+14¢"],
                ["A♯ǂ", "-13¢"],
                ["B", "+9¢"],
                ["B", "-18¢"],
                ["Bǂ", "+5¢"],
                ["Bǂ", "-23¢"],
            ]
        }

        // Pythagorean names 
        const namesKeysPythagorean = {
            5:[
                ["C", ""],
                ["Bx", "-9¢"],
                ["G♭♭", "+5¢"],
                ["Fx", "-5¢"],
                ["F♭♭♭", "+9¢"]
            ],

            7:[
                ["C", ""],
                ["E♭♭", "-10¢"],
                ["Cx♯", "+3¢"],
                ["E♯", "-6¢"],
                ["A♭♭", "+7¢"],
                ["Exx", "-3¢"],
                ["A♯", "+10¢"]
            ],
            9:[
                ["C", ""],
                ["Bx", "-3¢"],
                ["F♭♭", "-5¢"],
                ["E", "-6¢"],
                ["Dx♯", "-10¢"],
                ["Dxx", "+10¢"],
                ["A♭", "+6¢"],
                ["Gx", "+5¢"],
                ["D♭♭♭", "+3¢"]
            ],
            12:[
                ["C", ""],
                ["D♭", "+9¢"],
                ["D",  "-4¢"],
                ["E♭", "+6¢"],
                ["E",  "-8¢"],
                ["F",  "+2¢"],
                ["G♭", "+12¢"],
                ["G",  "-2¢"],
                ["A♭", "+8¢"],
                ["A",  "-5¢"],
                ["B♭", "+4¢"],
                ["B",  "-10¢"]            
            ],
            17:[
                ["C", ""],
                ["E♭♭♭", "+3¢"],
                ["Bx", "+5¢"],
                ["D", "+8¢"],
                ["F♭♭", "+11¢"],
                ["G♭♭♭", "-9¢"],
                ["Dx", "-7¢"],
                ["F", "-4¢"],
                ["A♭♭♭", "-1¢"],
                ["Ex", "+1¢"],
                ["G", "+4¢"],
                ["B♭♭♭", "+7¢"],
                ["Fx♯", "+9¢"],
                ["Gx", "-11¢"],
                ["B♭", "-8¢"],
                ["D♭♭♭", "-5¢"],
                ["Ax", "-3¢"],
            ],
            19:[
                ["C", ""],
                ["E♭♭♭", "-5¢"],
                ["Bx", "-10¢"],
                ["E♭♭", "+8¢"],
                ["Bx♯", "+4¢"],
                ["D♯", "-1¢"],
                ["F♭", "-6¢"],
                ["A♭♭♭", "-11¢"],
                ["F", "+7¢"],
                ["A♭♭♭", "+2¢"],
                ["Ex", "-2¢"],
                ["G", "-7¢"],
                ["Ex♯", "+11¢"],
                ["G♯", "+6¢"],
                ["B♭♭", "+1¢"],
                ["Fxx", "-6¢"],
                ["A♯", "-8¢"],
                ["D♭♭♭", "+10¢"],
                ["Ax", "+5"]
            ],

            22:[
                ["C", ""],
                ["Ax♯", "+9¢"],
                ["C♯", "-4¢"],
                ["Axx ", "+5¢"],
                ["Cx", "-8¢"],
                ["F♭♭", "+1¢"],
                ["D♯", "+10¢"],
                ["F♭", "-3 ¢"],
                ["Dx", "+6 ¢"],
                ["F", "-7 ¢"],
                ["Dx♯", "+2 ¢"],
                ["G♭", "+11¢"],
                ["Dxx ", "-2 ¢"],
                ["G", "+7 ¢"],
                ["B♭♭♭", "-6 ¢"],
                ["G♯", "+3 ¢"],
                ["D♭♭", "-10¢"],
                ["Gx", "-1 ¢"],
                ["C♭♭", "+8¢"],
                ["Gx♯", "-5¢"],
                ["C♭", "+4¢"],
                ["E♭♭♭", "-9¢"]
            ],
            24:[
                ["C", ""],
                ["Ax♯", "+5¢"], 
                ["D♭", "+9¢"], 
                ["F♭♭♭", "-8¢"], 
                ["D", "-4¢"], 
                ["Bx♯", "+1¢"], 
                ["E♭", "+6¢"], 
                ["Cx♯", "+10¢"], 
                ["E", "-8¢"], 
                ["Cxx", "-3¢"], 
                ["F", "+2¢"], 
                ["Dx♯", "+7¢"], 
                ["G♭", "+11¢"], 
                ["Dxx ", "-7¢"], 
                ["G", "-2¢"], 
                ["Ex♯", "+3¢"], 
                ["A♭", "+8¢"], 
                ["C♭♭♭", "-10¢"], 
                ["A", "-7¢"], 
                ["Fxx", "-1¢"], 
                ["B♭", "+4¢"], 
                ["Gx♯", "+8¢"], 
                ["B", "-9¢"], 
                ["Gxx", "-8¢"] 
            ],
            31:[
                ["C", ""],
                ["Ax#", "-7¢"],
                ["Ebbb", "+9¢"],
                ["C#", "+3¢"],
                ["Axx", "-4¢"],
                ["D", "-10¢"],
                ["Cx", "+6¢"],
                ["Fbb", "-1¢"],
                ["D#", "-7¢"],
                ["Cx#", "+9¢"],
                ["Fb", "+2¢"],
                ["Dx", "-4¢"],
                ["Gbb", "-11¢"],
                ["F", "+5¢"],
                ["Dx#", "-1¢"],
                ["Gb", "-8¢"],
                ["F#", "+8¢"],
                ["Dxx", "+1¢"],
                ["G", "-5¢"],
                ["Fx", "+11¢"],
                ["Bbbb", "+4¢"],
                ["G#", "-2¢"],
                ["Cbbb", "-9¢"],
                ["Bbb", "+7¢"],
                ["Gx", "+1¢"],
                ["Cbb", "-6¢"],
                ["Bb", "+10¢"],
                ["Gx#", "+4¢"],
                ["Cb", "-3¢"],
                ["Ax", "-9¢"],
                ["Gxx", "+7¢"]
            ],

            33:[
                ["C", ""],
                ["Ax#", "-9¢"],
                ["Ebbb", "+5¢"],
                ["C#", "-4¢"],
                ["B#", "+10¢"],
                ["Ebb", "+1¢"],
                ["Cx", "-8¢"],
                ["Bx#", "+5¢"],
                ["Eb", "-3¢"],
                ["D#", "+10¢"],
                ["Bxx", "+1¢"],
                ["E", "-8¢"],
                ["Dx", "+6¢"],
                ["Gbb", "-3¢"],
                ["F", "+11¢"],
                ["Dx#", "+2¢"],
                ["Gb", "-7¢"],
                ["F#", "+7¢"],
                ["Dxx", "-2¢"],
                ["G", "-11¢"],
                ["Fx", "+3¢"],
                ["Bbbb", "-6¢"],
                ["Ab", "+8¢"],
                ["Fx#", "-1¢"],
                ["Bbb", "-10¢"],
                ["A", "+3¢"],
                ["Fxx", "-5¢"],
                ["Cbb", "+8¢"],
                ["A#", "-1¢"],
                ["Dbbb", "-10¢"],
                ["Cb", "+4¢"],
                ["Ax", "-5¢"],
                ["Gxx", "+9¢"],
            ],
            
            53:[
                ["C", ""],
                ["B♯", ""],
                ["Ax♯", ""],
                ["E♭♭♭", ""],
                ["D♭", ""],
                ["C♯", ""],
                ["Bx", ""],
                ["Axx", ""],
                ["E♭♭", ""],
                ["D", ""],
                ["Cx", ""],
                ["Bx♯", ""],
                ["F♭♭", ""],
                ["E♭", ""],
                ["D♯", ""],
                ["Cx♯", ""],
                ["Bxx", ""],
                ["F♭", ""],
                ["E", ""],
                ["Dx", ""],
                ["Cxx", ""],
                ["G♭♭", ""],
                ["F", ""],
                ["E♯", ""],
                ["Dx♯", ""],
                ["A♭♭♭", ""],
                ["G♭", ""],
                ["F♯", ""],
                ["Ex", ""],
                ["Dxx", ""],
                ["A♭♭", ""],
                ["G", ""],
                ["Fx", ""],
                ["Ex♯", ""],
                ["B♭♭♭", ""],
                ["A♭", ""],
                ["G♯", ""],
                ["Fx♯", ""],
                ["Exx", ""],
                ["B♭♭", ""],
                ["A", ""],
                ["Gx", ""],
                ["Fxx", ""],
                ["C♭♭", ""],
                ["B♭", ""],
                ["A♯", ""],
                ["Gx♯", ""],
                ["D♭♭♭", ""],
                ["C♭", ""],
                ["B", ""],
                ["Ax", ""],
                ["Gxx", ""],
                ["D♭♭", ""]
            ]
        } ;

        // Audio context and nodes
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const keys = {};
        let reverbNode = createReverb();
        let isReverbOn = false;
        let isArpeggiatorOn = false;
        let arpeggiatorInterval = null;
        let arpeggiatorNotes = [];
        let arpeggiatorIndex = 0;
        let masterGainNode = context.createGain();
        masterGainNode.connect(context.destination);
        let tempo = 120;

        // Synth configurations
        const synthConfigs = {
            sine: {
                volume: -8,
                oscillator: { type: "sine" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            square: {
                volume: -8,
                oscillator: { type: "square" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            triangle: {
                volume: -8,
                oscillator: { type: "triangle" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            },
            sawtooth: {
                volume: -8,
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1.2 }
            }
        };

        let currentSynth = new Tone.PolySynth(Tone.Synth, synthConfigs.sine).toDestination();

        // Calculate frequencies for given EDO and base frequency
        function calculateFrequencies(edo, octaves, baseFreq = 261.6255653005986) {
            let frequencies = [];
            for (let o = 0; o < octaves; o++) {
                for (let i = 0; i < edo; i++) {
                    frequencies.push(baseFreq * Math.pow(2, (i + o * edo) / edo));
                }
            }
            return frequencies;
        }

        // Create a key element
        function createKey(label, frequency, centsDeviation="") {
            const key = document.createElement('div');
            key.className = 'key';
            key.dataset.frequency = frequency;
            key.innerText = label;
            key.setAttribute('tabindex', '0');
            key.setAttribute('role', 'button');
            key.addEventListener('keydown', (e) => {if (e.key === ' ' || e.key === 'Enter') { handleKeyToggle(frequency, key); e.preventDefault(); } });
            key.addEventListener('keyup', (e) => {if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleKeyUp(frequency, key); } });
            key.addEventListener('mousedown', () => handleKeyToggle(frequency, key));
            key.addEventListener('mouseup', () => handleKeyUp(frequency, key));
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleKeyToggle(frequency, key);
            });
            key.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleKeyUp(frequency, key);
            });
            const centsIndicator = document.createElement('span');
            centsIndicator.classList.add('cents-indicator');
		centsIndicator.textContent = centsDeviation;
            key.appendChild(centsIndicator);

		
            return key;
        }

        // Generate keyboard keys based on selected EDO and octaves
        function generateKeyboard(edo, octaves, keyNaming='sequence') {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';
            const config = edoConfigs[edo];
            const frequencies = calculateFrequencies(edo, octaves);
            let rows = [];

            for (let o = 0; o < octaves; o++) {
                let octaveContainer = document.createElement('div');
                octaveContainer.className = 'key-octave';

                let row1 = document.createElement('div');
                row1.className = 'key-row';
                let row2 = document.createElement('div');
                row2.className = 'key-row';
                let keyName;
		    let centsDeviationString = "";
                for (let i = 0; i < config.keys; i++) {
                    let key;
                    const freqIndex = i + (o * config.keys);
                    if (keyNaming === 'sequence'){
                        keyName = `${i + 1 + (o * config.keys)}`;
                    }
                    else if (keyNaming === 'simpleSequence'){
                       keyName = `${(i + (o * config.keys)) % edo + 1}`;
                    }
                    else if (keyNaming === 'simpleCents'){
                       keyName = `${(Math.trunc(1200 / (edo) * i) % 1200 )}`;
                    }
                    else if (keyNaming === 'name12edo'){
                        keyName = namesKeys12Edo[edo][i % edo][0];
                        centsDeviationString = namesKeys12Edo[edo][i % edo][1];
                    }
                    else if (keyNaming === 'name24edo'){
                        keyName = namesKeys24Edo[edo][i % edo][0];
                        centsDeviationString = namesKeys24Edo[edo][i % edo][1];
                    }
                    else if (keyNaming === 'namePythagorean'){
                        keyName = namesKeysPythagorean[edo][i % edo][0];
                        centsDeviationString = namesKeysPythagorean[edo][i % edo][1];
                    }
                    key = createKey(keyName, frequencies[freqIndex], centsDeviationString);
                    if (config.rows === 2 && i % 2 === 0) { row2.appendChild(key) ; }
                    else { row1.appendChild(key) ; }
                }
                octaveContainer.appendChild(row1);
                if (config.rows === 2) { octaveContainer.appendChild(row2); }
                rows.push(octaveContainer);
            }

            rows.forEach(row => keyboard.appendChild(row));
        }

        // Handle key toggle (mousedown/touchstart)
        function handleKeyToggle(frequency, key) {
            if (isArpeggiatorOn) {
                if (arpeggiatorNotes.some(n => n.frequency === frequency)) {
                    arpeggiatorNotes = arpeggiatorNotes.filter(n => n.frequency !== frequency);
                    key.classList.remove('pressed');
                } else {
                    arpeggiatorNotes.push({ frequency, key });
                    key.classList.add('pressed');
                }
            } else {
                handleKeyDown(frequency, key);
            }
        }

        // Handle key down (mousedown/touchstart)
        function handleKeyDown(frequency, key) {
            if (!keys[frequency]) {
                currentSynth.triggerAttack(frequency);
                keys[frequency] = true;
                key.classList.add('pressed');
            }
        }

        // Handle key up (mouseup/touchend)
        function handleKeyUp(frequency, key) {
            if (keys[frequency]) {
                currentSynth.triggerRelease(frequency);
                delete keys[frequency];
                key.classList.remove('pressed');
            }
        }

        // Toggle reverb effect
        function toggleReverb() {
            isReverbOn = !isReverbOn;
            if (isReverbOn) {
                currentSynth.connect(reverbNode);
            } else {
                currentSynth.disconnect(reverbNode);
            }
            document.getElementById('toggle-reverb').classList.toggle('active', isReverbOn);
        }

        // Create reverb node
        function createReverb() {
            const convolver = new Tone.Reverb(2).toDestination();
            return convolver;
        }

        // Toggle arpeggiator functionality
        function toggleArpeggiator() {
            isArpeggiatorOn = !isArpeggiatorOn;
            if (isArpeggiatorOn) {
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        currentSynth.triggerAttackRelease(noteInfo.frequency, "8n");
                        updateKeyColor(noteInfo.key);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / tempo); // Adjust the interval for the arpeggiator speed
            } else {
                clearInterval(arpeggiatorInterval);
                arpeggiatorNotes = [];
                arpeggiatorIndex = 0;
                resetKeyColors();
            }
            document.getElementById('toggle-arpeggiator').classList.toggle('active', isArpeggiatorOn);
        }

        // Update key color for arpeggiator
        function updateKeyColor(key) {
            key.classList.add('pressed');
            setTimeout(() => {
                key.classList.remove('pressed');
            }, 500);
        }

        // Reset key colors
        function resetKeyColors() {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('pressed');
            });
        }

        // Handle volume change
        function handleVolumeChange(event) {
            const volume = event.target.value;
            currentSynth.volume.value = volume - 50;
            document.getElementById('volume-value').innerText = `${volume}%`;
        }

        // Handle tempo change
        function handleTempoChange(event) {
            tempo = event.target.value;
            document.getElementById('tempo-value').innerText = `${tempo} BPM`;
            if (isArpeggiatorOn) {
                clearInterval(arpeggiatorInterval);
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        currentSynth.triggerAttackRelease(noteInfo.frequency, "8n");
                        updateKeyColor(noteInfo.key);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / tempo); // Adjust the interval for the arpeggiator speed
            }
            Tone.Transport.bpm.value = tempo;
        }

        // Handle drum volume change
        function handleDrumVolumeChange(event) {
            drumVolume = event.target.value;
            drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);
            document.getElementById('drum-volume-value').innerText = `${drumVolume}%`;
        }

        // Handle synth change
        function handleSynthChange(event) {
            const selectedSynth = event.target.value;
            currentSynth = new Tone.PolySynth(Tone.Synth, synthConfigs[selectedSynth]).toDestination();
            if (isReverbOn) {
                currentSynth.connect(reverbNode);
            }
        }

        // Event listeners for EDO and octave selection
        document.getElementById('edo-select').addEventListener('change', () => {
            const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
            generateKeyboard(edo, octaves, keyNamingId.value);
        });

        document.getElementById('octave-select').addEventListener('change', () => {
            const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
            generateKeyboard(edo, octaves, keyNamingId.value);
        });
    document.getElementById('keyNamingId').addEventListener('change', () =>{
        const edo = parseInt(document.getElementById('edo-select').value);
            const octaves = parseInt(document.getElementById('octave-select').value);
        const naming = keyNamingId.value;
            generateKeyboard(edo, octaves, keyNamingId.value);
    })

        // Event listeners for reverb, arpeggiator, and synth selection
        document.getElementById('toggle-reverb').addEventListener('click', toggleReverb);
        document.getElementById('toggle-arpeggiator').addEventListener('click', toggleArpeggiator);
        document.getElementById('volume-slider').addEventListener('input', handleVolumeChange);
        document.getElementById('tempo-slider').addEventListener('input', handleTempoChange);
        document.getElementById('drum-volume-slider').addEventListener('input', handleDrumVolumeChange);
        document.getElementById('synth-select').addEventListener('change', handleSynthChange);

        // About button event listener
        document.getElementById('about-btn').addEventListener('click', toggleAbout);

        // Generate default keyboard (12 EDO, 1 octave)
        generateKeyboard(12, 1);

        // Drum machine implementation
        const drumPadsContainer = document.getElementById('drum-pads');
        const drumEffectChain = new Tone.Gain().toDestination();
        const drumReverb = new Tone.Reverb(2).toDestination();
        const drumDistortion = new Tone.Distortion(0.4).toDestination();
        let currentDrumPreset = 'standard';
        let currentSynths = {};
        let rhythmLength = parseInt(document.getElementById('length').value);
        let isPlaying = false;
        let drumVolume = 50;

        const sounds = ['hihat', 'snare', 'kick'];
        const synths = {
            standard: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 4,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.01, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' }
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 400,
                    envelope: { attack: 0.001, decay: 0.1, release: 0.8 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
                }).connect(drumEffectChain)
            },
            electro: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.02,
                    octaves: 6,
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 1.2, attackCurve: 'exponential' }
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 300,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.6 },
                    harmonicity: 6,
                    modulationIndex: 24,
                    resonance: 3000,
                    octaves: 1.2
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
                }).connect(drumEffectChain)
            }
        };

        currentSynths = synths[currentDrumPreset];

        Tone.Transport.bpm.value = tempo;
        drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);

        // Create drum pads
        function createDrumPads() {
            drumPadsContainer.innerHTML = '';
            sounds.forEach(sound => {
                const row = document.createElement('div');
                row.classList.add('drum-row');
                const label = document.createElement('label');
                label.textContent = sound.charAt(0).toUpperCase() + sound.slice(1);
                row.appendChild(label);
                for (let i = 0; i < rhythmLength; i++) {
                    const pad = document.createElement('div');
                    pad.classList.add('drum-pad');
                    pad.dataset.sound = sound;
                    pad.dataset.step = i;
                    pad.setAttribute('role', 'button');
                    pad.setAttribute('tabindex', '0');
                    pad.setAttribute('aria-pressed', 'false');
                    pad.addEventListener('keypress', (e) => {if (e.key === " " || e.key === "Enter") {pad.click(); e.preventDefault()} }) ;
                    pad.addEventListener('click', () => {
                        pad.classList.toggle('active');

                        // togle value true/false of aria-pressed
                        if (pad.getAttribute('aria-pressed') === "false"){ pad.setAttribute('aria-pressed', 'true'); }
                        else if (pad.getAttribute('aria-pressed') === "true"){ pad.setAttribute('aria-pressed', 'false'); }
                    });
                    row.appendChild(pad);
                }
                drumPadsContainer.appendChild(row);
            });
        }

        // Create progress row
        function createProgressRow() {
            const progressRow = document.getElementById('progress-row');
            progressRow.innerHTML = '';
            for (let i = 0; i < rhythmLength; i++) {
                const step = document.createElement('div');
                step.classList.add('progress-step');
                step.dataset.step = i;
                progressRow.appendChild(step);
            }
        }

        // Play drum rhythm
        function playRhythm() {
            let step = 0;
            Tone.Transport.scheduleRepeat(time => {
                const currentPads = document.querySelectorAll(`.drum-pad[data-step="${step}"]`);
                const currentSteps = document.querySelectorAll(`.progress-step[data-step="${step}"]`);
                document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
                document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
                currentPads.forEach(pad => {
                    pad.classList.add('current');
                    if (pad.classList.contains('active')) {
                        if (pad.dataset.sound === 'snare') {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("8n", time);
                        } else {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("C3", "8n", time);
                        }
                    }
                });
                currentSteps.forEach(step => {
                    step.classList.add('current');
                });
                step = (step + 1) % rhythmLength;
            }, "8n");
            Tone.Transport.start();
        }

        // Stop drum rhythm
        function stopRhythm() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
            document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
        }

        // Toggle play/stop for drum machine
        function togglePlayStop() {
            if (isPlaying) {
                stopRhythm();
                document.getElementById('play-stop').textContent = 'Play Drum Machine';
            } else {
                playRhythm();
                document.getElementById('play-stop').textContent = 'Stop Drum Machine';
            }
            isPlaying = !isPlaying;
        }

        // Load preset rhythms
        function loadPreset(preset) {
            const presets = {
                standard: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                electro: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 6]],
                        ['snare', [4]]
                    ]
                },
                techno: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [4]]
                    ]
                },
                pop: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                rock: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                house: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                funk: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                },
                jazz: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 5]],
                        ['hihat', [1, 2, 3, 4, 6, 7]],
                        ['snare', [4]]
                    ]
                },
                progressive: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 4, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                progressive2: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 3, 5, 7]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                }
            };

            const selectedPreset = presets[preset];
            if (selectedPreset) {
                rhythmLength = selectedPreset.length;
                document.getElementById('length').value = rhythmLength;
                createDrumPads();
                selectedPreset.patterns.forEach(([sound, steps]) => {
                    steps.forEach(step => {
                        const pad = document.querySelector(`.drum-pad[data-sound="${sound}"][data-step="${step}"]`);
                        if (pad) {
                            pad.classList.add('active');
                            pad.setAttribute('aria-pressed', 'true');
                        }
                    });
                });
            }
        }

        // Handle drum sound change
        function handleDrumSoundChange(event) {
            const selectedSound = event.target.value;
            currentDrumPreset = selectedSound;
            currentSynths = synths[currentDrumPreset];
        }

        // Toggle effect (reverb or distortion)
        function toggleEffect(button, effect, isActive) {
            if (isActive) {
                drumEffectChain.disconnect(effect);
                button.classList.remove('active');
            } else {
                drumEffectChain.connect(effect);
                button.classList.add('active');
            }
            return !isActive;
        }

        let isReverbActive = false;
        let isDistortionActive = false;

        document.getElementById('reverb-button').addEventListener('click', () => {
            isReverbActive = toggleEffect(document.getElementById('reverb-button'), drumReverb, isReverbActive);
        });

        document.getElementById('distortion-button').addEventListener('click', () => {
            isDistortionActive = toggleEffect(document.getElementById('distortion-button'), drumDistortion, isDistortionActive);
        });

        document.getElementById('length').addEventListener('change', (e) => {
            rhythmLength = parseInt(e.target.value);
            createDrumPads();
            if (isPlaying) {
                stopRhythm();
                playRhythm();
            }
        });

        document.getElementById('play-stop').addEventListener('click', togglePlayStop);
        document.getElementById('preset').addEventListener('change', (e) => {
            loadPreset(e.target.value);
        });
        document.getElementById('drum-sound').addEventListener('change', handleDrumSoundChange);

        createDrumPads();
        loadPreset('standard');

        // Toggle About popup
        function toggleAbout() {
            const aboutPopup = document.getElementById('about-popup');
            aboutPopup.classList.toggle('active');
        }
    </script>
</body>
</html>
